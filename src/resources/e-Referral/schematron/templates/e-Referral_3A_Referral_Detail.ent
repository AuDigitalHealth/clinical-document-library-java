

    <!-- e-Referral Clinical Document:  7.1.1 REFERRAL DETAIL -->

    <!-- Context: ClinicalDocument/component/structuredBody/component[ref_det] -->

    <!-- Status: Last Reviewed: Not Reviewed.
         Status: Last Updated : 11/07/2012 -->

    <pattern name="p-e-Referral_3A_Referral_Detail-errors" id="p-e-Referral_3A_Referral_Detail-errors"
        see="#p-e-Referral_3A_Referral_Detail-errors">

        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component[cda:section/cda:code/@code='102.16347']">

            <report test="count(cda:section[cda:code/@code='102.16347']) > 1"> Error:
                e-Referral - 7.1.1 Referral Detail - "Referral Detail" - The 'section'
                tag shall appear only once. Refer to section 7.1.1 of
                the e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>
        <!-- REFERRAL DETAIL. - 1..1 -->
        <!-- section - 1..1 -->
        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']">

            <!-- entry[observation/code/@code='103.16620'] - 1..1 -->

            <report test="count(cda:entry[cda:observation/cda:code/@code='103.16620']) > 1"> Error:
                e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral DateTime" - The
                'entry' tag shall appear only once. Refer to section 7.1.1 of
                the e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- For 'entry[observation/code/@code='103.16620']' tag see below rule context:
                <rule context = "/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry[cda:observation/cda:code/@code='103.16620']"> -->


            <!-- entry[observation/code/@code='42349-1'] - 1..1 -->

            <report test="count(cda:entry[cda:observation/cda:code/@code='42349-1']) > 1"> Error:
                e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Reason" - The
                'entry' tag shall appear only once. Refer to section 7.1.1 of
                the e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- For 'entry[observation/code/@code='103.16620']' tag see below rule context:
                <rule context = "/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry[cda:observation/cda:code/@code='42349-1']"> -->


            <!-- entry[observation/code/@code='103.16622'] - 1..1 -->

            <report test="count(cda:entry[cda:observation/cda:code/@code='103.16622']) > 1"> Error:
                e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Validity Duration"
                - The 'entry' tag shall appear only once. Refer to
                section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- For 'entry' tag see below rule context:
                <rule context = "/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry[cda:observation/cda:code/@code='103.16622']"> -->

            <report test="count(cda:code[@code='102.16347']) > 1"> Error:
                e-Referral - 7.1.1 Referral Detail - "Referral Detail" - The 'code'
                tag shall appear only once. Refer to section 7.1.1 of
                the e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <assert test="cda:title"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail"
                - The 'title' tag is missing. Refer to section 7.1.1 of
                the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="count(cda:title) > 1">Error: e-Referral - 7.1.1 Referral Detail
                - "Referral Detail" - The 'title' tag shall appear only once. Refer to
                section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:title and normalize-space(cda:title) = ''"> Error:
                e-Referral - 7.1.1 Referral Detail - "Referral Detail" - The 'title' tag
                shall contain a value. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:title and not(translate(cda:title, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') = 'REFERRAL DETAIL')">
                Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail" - The 'title' tag
                shall contain the value 'Referral Detail'. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <assert test="cda:text"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail"
                - The 'text' tag is missing. Refer to section 7.1.1 of
                the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="count(cda:text) > 1">Error: e-Referral - 7.1.1 Referral Detail
                - "Referral Detail" - The 'text' tag shall appear only once. Refer to
                section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:text and normalize-space(cda:text) = ''"> Error:
                e-Referral - 7.1.1 Referral Detail - "Referral Detail" - The 'text' tag
                shall contain a value. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>

        <!-- entry (REFERRAL DATETIME)- 1..1 -->
        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry[cda:observation/cda:code/@code='103.16620']">

            <!-- observation - 1..1 -->

            <report test="count(cda:observation[cda:code/@code='103.16620']) > 1"> Error: e-Referral
                - 7.1.1 Referral Detail - "Referral Detail / Referral DateTime" - The 'observation'
                tag shall appear only once. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- For 'observation' tag see below rule context:
                <rule context = "/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='103.16620']"> -->

        </rule>

        <!-- observation - 1..1 -->
        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='103.16620']">

            <!-- 11/07 - Updated as per MANTIS task 3794 - Enforcing No Nullflavor attributes -->

            <assert test="not(@nullFlavor)">Error: e-Referral - 7.1.1 Referral Detail - Referral Detail /
                "Referral DateTime" - "ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry/cda:observation" -
                The 'observation' tag 'nullFlavor' attribute shall not be present. Refer to requirements in the NullFlavor Usage Clarification FAQ and section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- End of Update -->

            <!-- @classCode - 1..1 -->

            <assert test="@classCode"> Error: e-Referral - 7.1.1 Referral Detail - Referral Detail /
                "Referral DateTime" - The 'observation' tag 'classCode' attribute is missing. Refer
                to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="@classCode = 'OBS'"> Error: e-Referral - 7.1.1 Referral Detail - "Referral
                Detail / Referral DateTime" - The parent 'observation' tag 'classCode' attribute
                shall contain the value 'OBS' . Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @moodCode - 1..1 -->

            <assert test="@moodCode"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral DateTime" - The parent 'observation' tag 'moodCode' attribute is missing.
                Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="@moodCode = 'EVN'"> Error: e-Referral - 7.1.1 Referral Detail - "Referral
                Detail / Referral DateTime" - The parent 'observation' tag 'moodCode' attribute
                shall contain the value 'EVN' . Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- code -->

            <report test="count(cda:code[@code='103.16620']) > 1"> Error: e-Referral - 7.1.1
                Referral Detail - "Referral Detail / Referral DateTime" - The 'code' tag shall appear only once. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>


            <!-- For 'code' tag see below rule context:  <rule context = "cda:code[@code='103.16620']"> -->

            <!-- value - 1..1 -->

            <assert test="cda:value"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral DateTime" - The 'value' tag is missing. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="count(cda:value) > 1"> Error: e-Referral - 7.1.1 Referral Detail -
                "Referral Detail / Referral DateTime" - The 'value' tag shall appear only once. Refer
                to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- For 'value' tag see below rule context:
                <rule context = "/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='103.16620']/cda:value"> -->

        </rule>

        <!-- code -->
        <rule context="cda:code[@code='103.16620']">

            <!-- checking parent path -->

            <assert test="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation/cda:code[@code='103.16620']"
                >Error: e-Referral - 7.1.1 Referral Detail -
                The '/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation/cda:code[@code='103.16620']' path - 1 or more tags are missing.
                Refer to section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @codeSystem -->

            <assert test="@codeSystem = '1.2.36.1.2001.1001.101'"> Error: e-Referral - 7.1.1
                Referral Detail - "Referral Detail / Referral DateTime" - The 'code' tag
                'codeSystem' attribute shall contain the value '1.2.36.1.2001.1001.101'. Refer to section
                7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @codeSystemName -->

            <assert test="translate(@codeSystemName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') = 'NCTIS DATA COMPONENTS'"
                > Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral DateTime"
                - The 'code' tag 'codeSystemName' attribute shall contain the value 'NCTIS Data Components'. Refer
                to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @displayName -->

            <assert test="translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') = 'REFERRAL DATETIME'"
                > Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral DateTime"
                - The 'code' tag 'displayName' attribute shall contain the value 'Referral DateTime'. Refer to
                section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- 11/07 - Updated as per MANTIS task 3794 - Enforcing No Nullflavor attributes -->
            <assert test="not(@nullFlavor)">Error: e-Referral - 7.1.1
                Referral Detail - "Referral Detail / Referral DateTime" - "ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry/cda:observation/cda:code" -
                The 'code tag 'nullFlavor' attribute shall not be present. Refer to requirements in the NullFlavor Usage Clarification FAQ and section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2. </assert>

            <!-- End of Update -->

        </rule>

        <!-- value - 1..1 -->
        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='103.16620']/cda:value">

            <!-- @xsi:type -->

            <assert test="@xsi:type"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral DateTime" - The 'value' tag 'xsi:type' attribute is missing. Refer to
                section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="@xsi:type = 'TS'"> Error: e-Referral - 7.1.1 Referral Detail - "Referral
                Detail / Referral DateTime" - The 'value' tag 'xsi:type' attribute shall contain the value 'TS'. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @value -->

            <!-- Below test are already exist in datatype global check -->
            <!--
            <assert test="@value"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral DateTime" - The 'value' tag 'value' attribute is missing. Refer to
                section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="normalize-space(@value) = ''"> Error: e-Referral - 7.1.1 Referral Detail -
                "Referral Detail / Referral Detail" - The 'value' tag 'value' attribute shall contain a
                value. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <assert
                test="not(@value)           or
                not(contains(@value,'+'))   or
                floor(substring-before(@value,'+')) = number(substring-before(@value,'+'))"
                >Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Detail" -
                The 'value' tag 'value' attribute shall be a number. Refer to section 8.3 time and
                7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert
                test="not(@value)            or
                not(contains(@value,'-'))    or
                floor(substring-before(@value,'-')) = number(substring-before(@value,'-'))"
                >Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Detail" -
                The 'value' tag 'value' attribute shall be a number. Refer to section 8.3 time and
                7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert
                test="not(@value)           or
                not(contains(@value,'+'))   or
                floor(substring-after(@value,'+')) = number(substring-after(@value,'+'))"
                >Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Detail" -
                The 'value' tag 'value' attribute shall be a number. Refer to section 8.3 time and
                7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert
                test="not(@value)            or
                not(contains(@value,'-'))    or
                floor(substring-after(@value,'-')) = number(substring-after(@value,'-'))"
                >Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Detail" -
                The 'value' tag 'value' attribute shall be a number. Refer to section 8.3 time and
                7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert
                test="not(@value)            or
                normalize-space(@value) = '' or
                contains(@value,'+')         or
                contains(@value,'-')         or
                floor(@value) = number(@value)"
                >Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Detail" -
                The 'value' tag 'value' attribute shall be a number. Refer to section 8.3 time and
                7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>
            -->

             <!-- 11/07 - Updated as per MANTIS task 3794 - Enforcing No Nullflavor attributes -->
            <assert test="not(@nullFlavor)">Error: e-Referral - 7.1.1
                Referral Detail - "Referral Detail / Referral DateTime" - "ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry/cda:observation/cda:value" -
                The 'value tag 'nullFlavor' attribute shall not be present. Refer to requirements in the NullFlavor Usage Clarification FAQ and section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2. </assert>

            <!-- End of Update -->


            <!-- 31/10/2012 - Updated as per JIRA task CCAS-94 - Implement SCS requirement, "Exact dates SHALL be used" -->
<!-- CCAS-94 is not approved for release.
            <assert test="
                not(@value) or
                normalize-space(@value) = '' or
                contains(@value, '+') or
                contains(@value, '-') or
                (string-length(@value) = 8 or string-length(@value) >= 14)"
                >Error: e-Referral - 7.1.1 Referral Detail -
                "Referral Detail / Referral DateTime" -
                The 'value tag 'value' attribute shall be an exact date or exact datetime.
                Refer to section 3.3 of the e-Referral Structured Content Specification
                and section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2. </assert>

            <assert test="
                not(@value) or
                normalize-space(@value) = '' or
                not(contains(@value, '+')) or
                (string-length(substring-before(@value, '+')) = 8 or string-length(substring-before(@value, '+')) >= 14)"
                >Error: e-Referral - 7.1.1 Referral Detail -
                "Referral Detail / Referral DateTime" -
                The 'value tag 'value' attribute shall be an exact date or exact datetime.
                Refer to section 3.3 of the e-Referral Structured Content Specification
                and section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2. </assert>

            <assert test="
                not(@value) or
                normalize-space(@value) = '' or
                not(contains(@value, '-')) or
                (string-length(substring-before(@value, '-')) = 8 or string-length(substring-before(@value, '-')) >= 14)"
                >Error: e-Referral - 7.1.1 Referral Detail -
                "Referral Detail / Referral DateTime" -
                The 'value tag 'value' attribute shall be an exact date or exact datetime.
                Refer to section 3.3 of the e-Referral Structured Content Specification
                and section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2. </assert>
-->
            <!-- End of Update -->

        </rule>


        <!-- entry (REFERRAL REASON) - 1..1 -->
        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry[cda:observation/cda:code/@code='42349-1']">

            <!-- observation - 1..1 -->

            <report test="count(cda:observation[cda:code/@code='42349-1']) > 1"> Error: e-Referral -
                7.1.1 Referral Detail - "Referral Detail / Referral Reason" - The 'observation' tag
                shall appear only once. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- For 'observation' tag see below rule context:
                <rule context = "/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='42349-1']"> -->

        </rule>

        <!-- observation - 1..1 -->
        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='42349-1']">

             <!-- 11/07 - Updated as per MANTIS task 3794 - Enforcing No Nullflavor attributes -->

            <assert test="not(@nullFlavor)">Error: e-Referral - 7.1.1 Referral Detail - Referral Detail /
                "Referral Reason" - "ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry/cda:observation" -
                The 'observation' tag 'nullFlavor' attribute shall not be present. Refer to requirements in the NullFlavor Usage Clarification FAQ and section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- End of Update -->

            <!-- @classCode - 1..1 -->

            <assert test="@classCode"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail
                / Referral Reason" - The 'observation' tag 'classCode' attribute is missing. Refer
                to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="@classCode = 'OBS'"> Error: e-Referral - 7.1.1 Referral Detail - "Referral
                Detail / Referral Reason" - The parent 'observation' tag 'classCode' attribute shall
                be 'OBS' . Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @moodCode - 1..1 -->

            <assert test="@moodCode"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral Reason" - The 'observation' tag 'moodCode'attribute is missing. Refer to
                section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="@moodCode = 'EVN'"> Error: e-Referral - 7.1.1 Referral Detail - "Referral
                Detail / Referral Reason" - The parent 'observation' tag 'moodCode' attribute shall contain the value 'EVN'. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- code -->

            <report test="count(cda:code[@code='42349-1']) > 1"> Error: e-Referral - 7.1.1 Referral
                Detail - "Referral Detail / Referral Reason" - The 'code' tag shall appear only once. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- For 'code' tag see below rule context:  <rule context = "cda:code[@code='42349-1']"> -->


            <!-- value - 1..1 -->

            <assert test="cda:value"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral Reason" - The 'value' tag is missing. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="count(cda:value) > 1"> Error: e-Referral - 7.1.1 Referral Detail -
                "Referral Detail / Referral Reason" - The 'value' tag shall appear only once. Refer
                to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- For 'value' tag see below rule context:
                <rule context = "/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='42349-1']/cda:value"> -->

        </rule>

        <!-- code -->
        <rule context="cda:code[@code='42349-1']">

            <!-- checking parent path -->

            <assert test="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation/cda:code[@code='42349-1']"
                >Error: e-Referral - 7.1.1 Referral Detail -
                The '/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation/cda:code[@code='42349-1']' path - 1 or more tags are missing.
                Refer to section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @codeSystem -->

            <assert test="@codeSystem = '2.16.840.1.113883.6.1'"> Error: e-Referral - 7.1.1 Referral
                Detail - "Referral Detail / Referral Reason" - The 'code' tag 'codeSystem' attribute
                shall contain the value '2.16.840.1.113883.6.1'. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @codeSystemName -->

            <assert test="translate(@codeSystemName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') = 'LOINC'"
                > Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Reason" -
                The 'code' tag 'codeSystemName' attribute shall contain the value 'LOINC'. Refer to section 7.1.1
                of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @displayName -->

            <assert test="translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') = 'REASON FOR REFERRAL'"
                > Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Reason" -
                The 'code' tag 'displayName' attribute shall be 'Reason for referral'. Refer to
                section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- 11/07 - Updated as per MANTIS task 3794 - Enforcing No Nullflavor attributes -->
            <assert test="not(@nullFlavor)">Error: e-Referral - 7.1.1
                Referral Detail - "Referral Detail / Referral Reason" - "ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry/cda:observation/cda:code" -
                The 'code tag 'nullFlavor' attribute shall not be present. Refer to requirements in the NullFlavor Usage Clarification FAQ and section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2. </assert>

            <!-- End of Update -->

        </rule>

        <!-- value - 1..1 -->
        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='42349-1']/cda:value">

            <report test="normalize-space(.) = ''"> Error: e-Referral - 7.1.1 Referral Detail -
                "Referral Detail / Referral Reason" - The 'value' tag shall contain a value. Refer to
                section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @xsi:type -->

            <assert test="@xsi:type"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral Reason" - The 'value' tag 'xsi:type' attribute is missing. Refer to
                section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="@xsi:type = 'ST'"> Error: e-Referral - 7.1.1 Referral Detail - "Referral
                Detail / Referral Reason" - The 'value' tag 'xsi:type' attribute shall contain the value 'ST'. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- 11/07 - Updated as per MANTIS task 3794 - Enforcing No Nullflavor attributes -->
            <assert test="not(@nullFlavor)">Error: e-Referral - 7.1.1
                Referral Detail - "Referral Detail
                / Referral Reason" - "ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry/cda:observation/cda:value" -
                The 'value tag 'nullFlavor' attribute shall not be present. Refer to requirements in the NullFlavor Usage Clarification FAQ and section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2. </assert>

            <!-- End of Update -->

        </rule>


        <!-- entry (REFERRAL VALIDITY DURATION) - 1..1 -->
        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry[cda:observation/cda:code/@code='103.16622']">

            <!-- observation - 1..1 -->

            <report test="count(cda:observation[cda:code/@code='103.16622']) > 1"> Error: e-Referral
                - 7.1.1 Referral Detail - "Referral Detail / Referral Validity Duration" - The
                'observation' tag shall appear only once. Refer to
                section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- For 'observation' tag see below rule context:
                <rule context = "/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='103.16622']"> -->

        </rule>

        <!-- observation - 1..1 -->
        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='103.16622']">

             <!-- 11/07 - Updated as per MANTIS task 3794 - Enforcing No Nullflavor attributes -->

            <assert test="not(@nullFlavor)">Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral Validity Duration" - "ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry/cda:observation" -
                The 'observation' tag 'nullFlavor' attribute shall not be present. Refer to requirements in the NullFlavor Usage Clarification FAQ and section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- End of Update -->

            <!-- @classCode - 1..1 -->

            <assert test="@classCode"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail
                / Referral Validity Duration" - The 'observation' tag 'classCode' attribute is
                missing. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="@classCode = 'OBS'"> Error: e-Referral - 7.1.1 Referral Detail - "Referral
                Detail / Referral Validity Duration" - The parent 'observation' tag 'classCode'
                attribute shall contain the value 'OBS'. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @moodCode - 1..1 -->

            <assert test="@moodCode"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral Validity Duration" - The parent 'observation' tag 'moodCode' attribute is
                missing. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="@moodCode = 'EVN'"> Error: e-Referral - 7.1.1 Referral Detail - "Referral
                Detail / Referral Validity Duration" - The 'observation' tag 'moodCode' attribute
                shall contain the value 'EVN'. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- code -->

            <report test="count(cda:code[@code='103.16622']) > 1"> Error: e-Referral - 7.1.1
                Referral Detail - "Referral Detail / Referral Validity Duration" - The 'code' tag
                shall appear only once. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- For 'code' tag see below rule context:  <rule context = "cda:code[@code='103.16622']"> -->


            <!-- value - 1..1 -->

            <assert test="cda:value"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral Validity Duration" - The 'value' tag is missing. Refer to section 7.1.1 of
                the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="count(cda:value) > 1"> Error: e-Referral - 7.1.1 Referral Detail -
                "Referral Detail / Referral Validity Duration" - The 'value' tag shall appear only
                once. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- For 'value' tag see below rule context:
                <rule context = "/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='103.16622']/cda:value"> -->

        </rule>

        <!-- code -->
        <rule context="cda:code[@code='103.16622']">

            <!-- checking parent path -->

            <assert test="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation/cda:code[@code='103.16622']"
                >Error: e-Referral - 7.1.1 Referral Detail -
                The '/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation/cda:code[@code='103.16622']' path -
                1 or more tags are missing. Refer to section 7.1.1 of the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @codeSystem -->

            <assert test="@codeSystem = '1.2.36.1.2001.1001.101'"> Error: e-Referral - 7.1.1
                Referral Detail - "Referral Detail / Referral Validity Duration" - The 'code' tag
                'codeSystem' attribute shall contain the value '1.2.36.1.2001.1001.101'. Refer to section 7.1.1 of
                the e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @codeSystemName -->

            <assert
                test="translate(@codeSystemName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') = 'NCTIS DATA COMPONENTS'"
                > Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Validity
                Duration" - The 'code' tag 'codeSystemName' attribute shall contain the value 'NCTIS Data
                Components'. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- @displayName -->

            <assert
                test="translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') = 'REFERRAL VALIDITY DURATION'"
                > Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Validity
                Duration" - The 'code' tag 'displayName' attribute shall be 'Referral Validity
                Duration'. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>


            <!-- 11/07 - Updated as per MANTIS task 3794 - Enforcing No Nullflavor attributes -->
            <assert test="not(@nullFlavor)">Error: e-Referral - 7.1.1
                Referral Detail - "Referral Detail /
                Referral Validity Duration" - "ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry/cda:observation/cda:code" -
                The 'code tag 'nullFlavor' attribute shall not be present. Refer to requirements in the NullFlavor Usage Clarification FAQ and section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2. </assert>

            <!-- End of Update -->

        </rule>

        <!-- value - 1..1 -->
        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='103.16622']/cda:value">

            <!-- @xsi:type -->

            <assert test="@xsi:type"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral Validity Duration" - The 'value' tag 'xsi:type' attribute is missing.
                Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="@xsi:type = 'IVL_TS'"> Error: e-Referral - 7.1.1 Referral Detail -
                "Referral Detail / Referral Validity Duration" - The 'value' tag 'xsi:type'
                attribute shall contain the value 'IVL_TS'. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>


            <!-- either (low and/or high tags) or a width tag -->

            <report test="cda:width and (cda:low or cda:high)"
                >Error: e-Referral - 7.1.1 Referral Detail - "Referral
                Detail / Referral Validity Duration" - The 'value' tag shall have 'width' or 'low' and/or 'high' tags but not both tag combinations.
                Check all 'time' tags to find the attribute. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>


            <!-- low - 1..1 -->

            <report test="count(cda:low) > 1"> Error: e-Referral - 7.1.1 Referral Detail - "Referral
                Detail / Referral Validity Duration" - The 'low' tag shall appear only once. Refer
                to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- high - 1..1 -->

            <report test="count(cda:high) > 1"> Error: e-Referral - 7.1.1 Referral Detail -
                "Referral Detail / Referral Validity Duration" - The 'high' tag shall appear only
                once. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- 11/07 - Updated as per MANTIS task 3794 - Enforcing No Nullflavor attributes -->
            <assert test="not(@nullFlavor)">Error: e-Referral - 7.1.1
                Referral Detail - "Referral Detail /
                Referral Validity Duration" - "ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section/cda:entry/cda:observation/cda:value" -
                The 'value tag 'nullFlavor' attribute shall not be present. Refer to requirements in the NullFlavor Usage Clarification FAQ and section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2. </assert>

            <!-- End of Update -->

            <!-- For 'low' and 'high' tag see below rule context:
                <rule context = "/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='103.16622']/cda:value/cda:low"> -->

        </rule>

        <rule context="/cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='103.16622']/cda:value/cda:low |
                       /cda:ClinicalDocument/cda:component/cda:structuredBody/cda:component/cda:section[cda:code/@code='102.16347']/cda:entry/cda:observation[cda:code/@code='103.16622']/cda:value/cda:high">

            <assert test="@value"> Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail /
                Referral Validity Duration" - The 'low'/'high' tag 'value' attribute is missing.
                Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="normalize-space(@value) = ''"> Error: e-Referral - 7.1.1 Referral Detail -
                "Referral Detail / Referral Validity Duration" - The 'low'/'high' tag 'value'
                attribute shall contain a value. Refer to section 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <assert
                test="not(@value)           or
                not(contains(@value,'+'))   or
                floor(substring-before(@value,'+')) = number(substring-before(@value,'+'))"
                >Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Validity
                Duration" - The 'low'/'high' tag 'value' attribute shall be a number. Refer to
                section 8.3 time and 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert
                test="not(@value)            or
                not(contains(@value,'-'))    or
                floor(substring-before(@value,'-')) = number(substring-before(@value,'-'))"
                >Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Validity
                Duration" - The 'low'/'high' tag 'value' attribute shall be a number. Refer to
                section 8.3 time and 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert
                test="not(@value)           or
                not(contains(@value,'+'))   or
                floor(substring-after(@value,'+')) = number(substring-after(@value,'+'))"
                >Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Validity
                Duration" - The 'low'/'high' tag 'value' attribute shall be a number. Refer to
                section 8.3 time and 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert
                test="not(@value)            or
                not(contains(@value,'-'))    or
                floor(substring-after(@value,'-')) = number(substring-after(@value,'-'))"
                >Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Validity
                Duration" - The 'low'/'high' tag 'value' attribute shall be a number. Refer to
                section 8.3 time and 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert
                test="not(@value)            or
                normalize-space(@value) = '' or
                contains(@value,'+')         or
                contains(@value,'-')         or
                floor(@value) = number(@value)"
                >Error: e-Referral - 7.1.1 Referral Detail - "Referral Detail / Referral Validity
                Duration" - The 'low'/'high' tag 'value' attribute shall be a number. Refer to
                section 8.3 time and 7.1.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

        </rule>

    </pattern>

