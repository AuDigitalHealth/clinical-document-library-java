
    <!-- ================================================================ -->
    <!-- PLEASE DON'T EDIT THIS FILE. ITS CODE IS GENERATED FROM TEMPLATE -->
    <!-- AND IS UNIFORM ACROSS ALL PACKAGES.                              -->
    <!-- ================================================================ -->

    <!-- e-Referral Clinical Document:  Global Checks -->

    <!-- Context: ClinicalDocument -->

    <!-- Status: Last Reviewed:
         Status: Last Updated : 3/12/2012 -->


    <pattern name="p-e-Referral_Global_Checks-errors"
        id="p-e-Referral_Global_Checks-errors"
        see="#p-e-Referral_Global_Checks-errors">


        <!-- BEGIN :: Common Patterns: 8.1 CODE -->

        <rule
            context="cda:code | ext:code | cda:methodCode | ext:methodCode | ext:jobClassCode">

            <report test="cda:originalText and normalize-space(cda:originalText) = ''"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/cda:originalText" - The 'originalText' tag shall contain a value.
                Check all 'cda:code/cda:originalText' tags to find the missing text.
                Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="count(cda:originalText) > 1"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/cda:originalText" - The 'originalText' tag shall appear only once.
                Check all 'cda:code/cda:originalText' tags to find the duplicate text.
                Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <assert test="
                cda:originalText or (@code and @codeSystem) or @nullFlavor"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/@code" attribute - The 'code' tag shall have 'originalText' or
                'code and codeSystem' or 'nullFlavor' attributes.
                Check all 'cda:code' tags to find the missing tag or attribute.
                Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="@nullFlavor and normalize-space(@nullFlavor) = ''"
                >Error: e-Referral -
                Global Clinical Document check for "cda:code/@nullFlavor" attribute - The 'code'
                tag 'nullFlavor' attribute shall contain a value.
                Check all 'cda:code' tags 'nullFlavor' attributes to find the missing value.
                Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@code and normalize-space(@code) = ''"
                >Error: e-Referral -
                Global Clinical Document check for "cda:code/@code" attribute - The 'code'
                tag 'code' attribute shall contain a value.
                Check all 'cda:code' tags 'code' attributes to find the missing value.
                Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@codeSystem and normalize-space(@codeSystem) = ''"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/@codeSystem" attribute - The 'code' tag 'codeSystem' attribute
                shall contain a value. Check all 'cda:code' tags 'codeSystem' attributes to
                find the missing value. Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@codeSystemName and normalize-space(@codeSystemName) = ''"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/@codeSystemName" attribute - The 'code' tag 'codeSystemName'
                attribute shall contain a value. Check all 'cda:code' tags 'codeSystemName'
                attributes to find the missing value. Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@displayName and normalize-space(@displayName) = ''"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/@displayName" attribute - The 'code' tag 'displayName' attribute
                shall contain a value. Check all 'cda:code' tags 'displayName' attributes to
                find the missing value. Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>


        <rule context="cda:code/cda:translation | ext:code/cda:translation | ext:jobClassCode/cda:translation">

            <assert test="@code and @codeSystem or (@nullFlavor='OTH' and @codeSystem)"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/cda:translation" attributes - The 'translation' tag shall have
                'code' and 'codeSystem' attributes. Check all 'cda:code/cda:translation' tags
                to find the missing tag or attribute. Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="@nullFlavor and normalize-space(@nullFlavor) = ''"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/cda:translation/@nullFlavor" attribute - The 'translation' tag 'nullFlavor'
                attribute shall contain a value. Check all 'cda:code/cda:translation' tags
                'nullFlavor' attributes to find the missing value.
                Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@code and normalize-space(@code) = ''"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/cda:translation/@code" attribute - The 'translation' tag 'code'
                attribute shall contain a value. Check all 'cda:code/cda:translation' tags
                'code' attributes to find the missing value.
                Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@codeSystem and normalize-space(@codeSystem) = ''"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/cda:translation/@codeSystem" attribute - The 'translation' tag
                'codeSystem' attribute shall contain a value. Check all
                'cda:code/cda:translation' tags 'codeSystem' attributes to find the missing
                value. Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@codeSystemName and normalize-space(@codeSystemName) = ''"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/cda:translation/@codeSystemName" attribute - The 'translation' tag
                'codeSystemName' attribute shall contain a value. Check all
                'cda:code/cda:translation' tags 'codeSystemName' attributes to find the
                missing value. Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@displayName and normalize-space(@displayName) = ''"
                >Error: e-Referral - Global Clinical Document check for
                "cda:code/cda:translation/@displayName" attribute - The 'translation' tag
                'displayName' attribute shall contain a value. Check all
                'cda:code/cda:translation' tags 'displayName' attributes to find the missing
                value. Refer to section 8.1 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>




        <!-- BEGIN :: Common Patterns: 8.2 ID -->

        <rule context="cda:id | ext:id[not(ancestor::ext:entitlement)]">

            <assert test="@root or @nullFlavor"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag shall have at least
                'root' or 'nullFlavor' attributes. Check all 'cda:id' tags to find the missing
                'root' or 'nullFlavor' attributes. Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="@root and normalize-space(@root) =  ''"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'root' attribute shall
                contain a value. Check all 'cda:id' tags 'root' attribute to find the missing
                value. Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @root has to be a UUID or OID -->
            <assert test="
                not(@root) or
                normalize-space(@root) = '' or
                contains(@root, '-') or
                contains(@root, '.')"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'root' attribute shall
                contain an UUID or OID. Check all 'cda:id' tags to find the incorrect 'root' attribute.
                Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- UUID format test -->
            <report test="
                @root and
                normalize-space(@root) != '' and
                contains(@root, '-') and not(
                string-length(@root) = 36 and
                substring(@root,  9, 1) = '-' and substring(@root, 14, 1) = '-' and
                substring(@root, 19, 1) = '-' and substring(@root, 24, 1) = '-' and
                translate(substring(@root,  1,  8), '0123456789ABCDEFabcdef', '0000000000000000000000') = '00000000' and
                translate(substring(@root, 10,  4), '0123456789ABCDEFabcdef', '0000000000000000000000') = '0000' and
                translate(substring(@root, 15,  4), '0123456789ABCDEFabcdef', '0000000000000000000000') = '0000' and
                translate(substring(@root, 20,  4), '0123456789ABCDEFabcdef', '0000000000000000000000') = '0000' and
                translate(substring(@root, 25, 12), '0123456789ABCDEFabcdef', '0000000000000000000000') = '000000000000')
                ">Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'root' attribute shall
                be a valid UUID. Check all 'cda:id' tags to find the incorrect 'root' attribute.
                Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- OID format test -->
            <report
                test="
                @root and
                normalize-space(@root) != '' and
                contains(@root,'.') and not(
                substring(@root, 1, 1) != '0' and
                substring(@root, 1, 1) != '.' and
                substring(@root, string-length(@root), 1) != '.' and
                number(translate(@root, '0123456789.', '00000000000')) = 0)
                ">Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'root' attribute shall
                be a valid OID. Check all 'cda:id' tags to find the incorrect 'root' attribute.
                Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- Health Identifier tests (if it starts with HI prefix) -->

            <assert
                test="
                not(@root) or
                not(starts-with(@root, '1.2.36.1.2001.1003.0.80036') or
                    starts-with(@root, '1.2.36.1.2001.1007.1.80036') or
                    starts-with(@root, '1.2.36.1.2001.1007.10.80036') or
                    starts-with(@root, '1.2.36.1.2001.1007.20.80036')) or (
                    not(contains(substring-after(@root, '80036'), '.')) and
                    string-length('80036') + string-length(substring-after(@root, '80036')) = 16
                )"
                >Error: e-Referral - 8.2 Employment -
                The 'id' tag 'root' attribute shall contain an OID for Health Identifier, which
                should be ended with a national 16 digits unique identification number. Check all
                'ext:asEmployment/ext:employerOrganization/cda:asOrganizationPartOf/cda:wholeOrganization/ext:asEntityIdentifier/ext:id'
                tags to find the incorrect value.
                Refer to section 8.2 Employment of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test = "
                not(@root) or
                not(starts-with(@root, '1.2.36.1.2001.1003.0.80036') or
                    starts-with(@root, '1.2.36.1.2001.1007.1.80036') or
                    starts-with(@root, '1.2.36.1.2001.1007.10.80036') or
                    starts-with(@root, '1.2.36.1.2001.1007.20.80036')) or
                contains(substring-after(@root, '80036'), '.') or
                not(string-length('80036') + string-length(substring-after(@root, '80036')) = 16) or (
                (
                    number(substring(string(2 * 8), 1, 1)) + number(substring(string(2 * 8), 2, 1)) +
                    0 +
                    2 * 0 +
                    3 +
                    number(substring(string(2 * 6), 1, 1)) + number(substring(string(2 * 6), 2, 1)) +
                    number(substring(substring-after(@root, '80036'), 1, 1)) +
                    number(substring(string(2 * substring(substring-after(@root, '80036'), 2, 1)), string-length(string(2 * substring(substring-after(@root, '80036'), 2, 1))), 1)) +
                    number(substring(string(number(substring(substring-after(@root, '80036'), 2, 1)) div 5), 1, 1)) +
                    number(substring(substring-after(@root, '80036'), 3, 1)) +
                    number(substring(string(2 * substring(substring-after(@root, '80036'), 4, 1)), string-length(string(2 * substring(substring-after(@root, '80036'), 4, 1))), 1)) +
                    number(substring(string(number(substring(substring-after(@root, '80036'), 4, 1)) div 5), 1, 1)) +
                    number(substring(substring-after(@root, '80036'), 5, 1)) +
                    number(substring(string(2 * substring(substring-after(@root, '80036'), 6, 1)), string-length(string(2 * substring(substring-after(@root, '80036'), 6, 1))), 1)) +
                    number(substring(string(number(substring(substring-after(@root, '80036'), 6, 1)) div 5), 1, 1)) +
                    number(substring(substring-after(@root, '80036'), 7, 1)) +
                    number(substring(string(2 * substring(substring-after(@root, '80036'), 8, 1)), string-length(string(2 * substring(substring-after(@root, '80036'), 8, 1))), 1)) +
                    number(substring(string(number(substring(substring-after(@root, '80036'), 8, 1)) div 5), 1, 1)) +
                    number(substring(substring-after(@root, '80036'), 9, 1)) +
                    number(substring(string(2 * substring(substring-after(@root, '80036'),10, 1)), string-length(string(2 * substring(substring-after(@root, '80036'),10, 1))), 1)) +
                    number(substring(string(number(substring(substring-after(@root, '80036'),10, 1)) div 5), 1, 1)) +
                    number(substring(substring-after(@root, '80036'), 11, 1))
                ) mod 10 = 0)"
                >Error: e-Referral - 8.2 Employment -
                The 'id' tag 'root' attribute shall have an valid Luhn check digit in the OID for Health Identifier. Check all
                'ext:asEmployment/ext:employerOrganization/cda:asOrganizationPartOf/cda:wholeOrganization/ext:asEntityIdentifier/ext:id'
                tags to find the incorrect value.
                Refer to section 8.2 Employment of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="@nullFlavor and normalize-space(@nullFlavor) = ''"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'nullFlavor' attribute
                shall contain a value. Check all 'cda:id' tags 'nullFlavor' attribute to find the
                missing value. Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report
                test="@nullFlavor and translate(@nullFlavor, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')!='NA'"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'nullFlavor' attribute
                shall contain the value 'NA'. Check all 'cda:id' tags to find the incorrect
                'nullFlavor' attribute. Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@extension and not(@root)"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'root' attribute
                is missing for the existence of 'extension' attribute. Check all 'cda:id' tags to
                find the 'extension' without 'root' attributes. Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@extension and normalize-space(@extension) = ''"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'extension' attribute
                shall contain a value. Check all 'cda:id' tags 'extension' attribute to find the
                missing value. Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@assigningAuthorityName and not(@root)"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'root' attribute
                is missing for the existence of 'assigningAuthorityName' attribute. Check all
                'cda:id' tags to find the 'assigningAuthorityName' without 'root' attributes.
                Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@assigningAuthorityName and normalize-space(@assigningAuthorityName) = ''"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'assigningAuthorityName'
                attribute shall contain a value. Check all 'cda:id' tags 'assigningAuthorityName'
                attribute to find the missing value. Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@displayable and not(@root)"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'root' attribute
                is missing for the existence of 'displayable' attribute. Check all 'cda:id' tags to
                find the 'displayable' without 'root' attributes. Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@displayable and normalize-space(@displayable) = ''"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'displayable' attribute
                shall contain a value. Check all 'cda:id' tags 'displayable' attribute to find the
                missing value. Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@displayable and
                normalize-space(@displayable) != '' and
                not(@displayable = 'true' or @displayable = 'false')"
                >Error: e-Referral -
                Global Clinical Document check for "id" tag - The 'id' tag 'displayable' attribute
                shall contain the value 'true' or 'false'. Check all 'cda:id' tags 'displayable'
                attribute to find the incorrect value. Refer to section 8.2 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>




        <!-- BEGIN :: Common Patterns: 8.3 TIME -->

        <!--cda:time, ext:time, cda:birthTime, ext:birthTime, cda:deceasedTime, ext:deceasedTime, cda:effectiveTime, ext:effectiveTime -->

        <!--
        ISO 8601 time syntax : 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
         -->
        <rule context="cda:time | ext:time | cda:birthTime | ext:birthTime | cda:deceasedTime | ext:deceasedTime | cda:effectiveTime | ext:effectiveTime">

            <!-- A simple timestamp (point in time) will only contain a value attribute containing the time value, expressed as a series of digits as long as required or available.-->

            <report test="@xsi:type and normalize-space(@xsi:type) = ''"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time' tag 'xsi:type' attribute shall contain a value. Check all
                'time' tags to find the attribute. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="
                @xsi:type and
                normalize-space(@xsi:type) != '' and
                @xsi:type != 'TS' and
                @xsi:type != 'IVL_TS' and
                @xsi:type != 'PIVL_TS'"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time' tag 'xsi:type' attribute shall contain the value 'TS',
                'IVL_TS' or 'PIVL_TS'. Check all 'time' tags to find the attribute.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>


            <assert test="
                @value or cda:low or cda:high or cda:width or cda:frequency or
                @nullFlavor"
                >Error: e-Referral -
                Global Clinical Document check for "time" tag -
                The 'time' tag shall have 'value' or 'nullFlavor' attribute or
                'low' or 'high' or 'centre' or 'width' child tags.
                Check all 'cda:time' tag to find the missing tag or attribute.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="@nullFlavor and normalize-space(@nullFlavor) = ''"
                >Error: e-Referral -
                Global Clinical Document check for "time" tag -
                The 'time' tag 'nullFlavor' attribute shall contain a value.
                Check all 'cda:time' tag to find the missing attribute value.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@value and normalize-space(@value) = ''"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time' tag 'value' attribute shall contain a value.
                Check all 'time' tags to find the missing attribute value.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>


            <!-- Any time that is more specific than a day SHALL include a timezone. -->
            <report test="
                @value                      and
                string-length(@value) > 8   and
                not(contains(@value,'+'))   and not(contains(@value,'-'))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time' tag 'value' attribute shall contain a timezone value.
                "Any time that is more specific than a day SHALL include a timezone".
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- check value of time with fraction of seconds, with or without timezone
                 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                  ^^^^^^^^^^^^^^                                                    -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                not(contains(@value,'.'))    or
                ((string(number(substring-before(@value,'.'))) != string(number(@value))) and
                (string-length(substring-before(@value,'.')) = 14))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect DateTime - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check fraction of second value, with a '+' timezone
                 'YYYYMMDDHHMMSS.UUUU+ZZzz'
                                 ^^^^                            -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                not(contains(@value,'+'))    or
                not(contains(@value,'.'))    or
                ((string(number(substring-before(substring-after(@value,'.'),'+'))) != string(number(@value))) and
                (string-length(substring-before(substring-after(@value,'.'),'+')) = 4))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect fraction of second - The 'time' tag 'value' attribute
                shall be a number formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check fraction of second value, with a '-' timezone
                 'YYYYMMDDHHMMSS.UUUU-ZZzz'
                                 ^^^^                            -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                not(contains(@value,'-'))    or
                not(contains(@value,'.'))    or
                ((string(number(substring-before(substring-after(@value,'.'),'-'))) != string(number(@value))) and
                (string-length(substring-before(substring-after(@value,'.'),'-')) = 4))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect fraction of second - The 'time' tag 'value' attribute
                shall be a number formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of time without fraction of seconds, and with a '+' timezone
                 'YYYYMMDDHHMM+ZZzz' or 'YYYYMMDDHHMMSS+ZZzz'
                  ^^^^^^^^^^^^           ^^^^^^^^^^^^^^                               -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                contains(@value,'.')         or
                not(contains(@value,'+'))    or
                ((string(number(substring-before(@value,'+'))) != string(number(@value))) and
                (string-length(substring-before(@value,'+')) > 11) and
                (string-length(substring-before(@value,'+')) &lt; 15) and
                (string-length(substring-before(@value,'+')) mod 2 = 0))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect DateTime - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of time without fraction of seconds, and with a '-' timezone
                 'YYYYMMDDHHMM-ZZzz' or 'YYYYMMDDHHMMSS-ZZzz'
                  ^^^^^^^^^^^^           ^^^^^^^^^^^^^^                               -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                contains(@value,'.')         or
                not(contains(@value,'-'))    or
                ((string(number(substring-before(@value,'-'))) != string(number(@value))) and
                (string-length(substring-before(@value,'-')) > 11) and
                (string-length(substring-before(@value,'-')) &lt; 15) and
                (string-length(substring-before(@value,'-')) mod 2 = 0))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect DateTime - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of timezone with a '+' timezone
                 'YYYYMMDDHHMMSS.UUUU+ZZzz'
                                      ^^^^               -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                not(contains(@value,'+'))    or
                ((string(number(substring-after(@value,'+'))) != string(number(@value))) and
                ((string-length(substring-after(@value,'+')) = 2) or (string-length(substring-after(@value,'+')) = 4)))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect TimeZone - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of timezone with a '-' timezone
                 'YYYYMMDDHHMMSS.UUUU-ZZzz'
                                      ^^^^               -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                not(contains(@value,'-'))    or
                ((string(number(substring-after(@value,'-'))) != string(number(@value))) and
                ((string-length(substring-after(@value,'-')) = 2) or (string-length(substring-after(@value,'-')) = 4)))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect TimeZone - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of time without fraction of seconds, and without timezone (could safely assume year only)
                 'YYYYMMDD'
                  ^^^^                                                                                             -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                contains(@value,'.')         or
                contains(@value,'+')         or
                contains(@value,'-')         or
                ((string(number(@value)) != string(number('a'))) and
                (string-length(@value) >= 4))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect DateTime - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of year, assume years from 19xx - XXxx
                 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                  ^^^^                                             -->
<!--
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                ((number(substring(@value,1,2)) >= 19) and
                (number(substring(@value,1,2)) &lt; 21))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Year - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>
-->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                number(substring(@value,1,2)) >= 19
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Year - The value for year must be more recent than 1900.
                The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of month, from 1 to 12
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                     ^^                                            -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                string-length(@value) &lt; 5 or
                ((number(substring(@value,5,2)) >= 1) and
                (number(substring(@value,5,2)) &lt; 13))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Month - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of date, month 1,3,5,7,8,10,12 shall be from 1 to 31
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                       ^^                                                     -->
            <assert test="
                not(@value)                           or
                normalize-space(@value) = ''          or
                string-length(@value) &lt; 7          or
                number(substring(@value,5,2)) = 2     or
                number(substring(@value,5,2)) = 4     or
                number(substring(@value,5,2)) = 6     or
                number(substring(@value,5,2)) = 9     or
                number(substring(@value,5,2)) = 11    or
                number(substring(@value,5,2)) > 12    or
                ((number(substring(@value,7,2)) >= 1) and
                (number(substring(@value,7,2)) &lt; 32))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Date - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of date, month 4,6,9,11 shall be from 1 to 30
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                       ^^                                              -->
            <assert test="
                not(@value)                           or
                normalize-space(@value) = ''          or
                string-length(@value) &lt; 7          or
                number(substring(@value,5,2)) = 1     or
                number(substring(@value,5,2)) = 2     or
                number(substring(@value,5,2)) = 3     or
                number(substring(@value,5,2)) = 5     or
                number(substring(@value,5,2)) = 7     or
                number(substring(@value,5,2)) = 8     or
                number(substring(@value,5,2)) = 10    or
                number(substring(@value,5,2)) = 12    or
                number(substring(@value,5,2)) > 12    or
                ((number(substring(@value,7,2)) >= 1) and
                (number(substring(@value,7,2)) &lt; 31))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Month - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of date, month 2 shall be from 1 to 29 if leap year
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                       ^^                                                    -->
            <assert test="
                not(@value)                           or
                normalize-space(@value) = ''          or
                string-length(@value) &lt; 7          or
                number(substring(@value,5,2)) = 1     or
                number(substring(@value,5,2)) = 3     or
                number(substring(@value,5,2)) = 4     or
                number(substring(@value,5,2)) = 5     or
                number(substring(@value,5,2)) = 6     or
                number(substring(@value,5,2)) = 7     or
                number(substring(@value,5,2)) = 8     or
                number(substring(@value,5,2)) = 9     or
                number(substring(@value,5,2)) = 10    or
                number(substring(@value,5,2)) = 11    or
                number(substring(@value,5,2)) = 12    or
                number(substring(@value,5,2)) > 12    or
                (number(substring(@value,1,4)) mod 4) != 0 or
                ((number(substring(@value,7,2)) >= 1) and
                (number(substring(@value,7,2)) &lt; 30))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Date - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of date, month 2 shall be from 1 to 28 if not leap year
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                       ^^                                                        -->
            <assert test="
                not(@value)                           or
                normalize-space(@value) = ''          or
                string-length(@value) &lt; 7          or
                number(substring(@value,5,2)) = 1     or
                number(substring(@value,5,2)) = 3     or
                number(substring(@value,5,2)) = 4     or
                number(substring(@value,5,2)) = 5     or
                number(substring(@value,5,2)) = 6     or
                number(substring(@value,5,2)) = 7     or
                number(substring(@value,5,2)) = 8     or
                number(substring(@value,5,2)) = 9     or
                number(substring(@value,5,2)) = 10    or
                number(substring(@value,5,2)) = 11    or
                number(substring(@value,5,2)) = 12    or
                number(substring(@value,5,2)) > 12    or
                (number(substring(@value,1,4)) mod 4) = 0 or
                ((number(substring(@value,7,2)) >= 1) and
                (number(substring(@value,7,2)) &lt; 29))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Date - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of hour, from 0 to 23
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                         ^^                                        -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                string-length(substring-before(translate(@value, '-', '+'),'+')) &lt; 9 or
                ((number(substring(@value,9,2)) >= 0) and
                (number(substring(@value,9,2)) &lt; 24))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Hour - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of minute, from 0 to 59
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                           ^^                                      -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                string-length(substring-before(translate(@value, '-', '+'),'+')) &lt; 11 or
                ((number(substring(@value,11,2)) >= 0) and
                (number(substring(@value,11,2)) &lt; 60))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Minute - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of second, from 0 to 59
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                             ^^                                    -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                string-length(substring-before(translate(@value, '-', '+'),'+')) &lt; 13 or
                ((number(substring(@value,13,2)) >= 0) and
                (number(substring(@value,13,2)) &lt; 60))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Second - The 'time' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="count(cda:low) > 1"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'low' tag shall appear only once. Check all 'time/low' tags to find the
                duplicate tags. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="count(cda:high) > 1"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'high' tag shall appear only once. Check all 'time/high' tags to find the
                duplicate tags. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="count(cda:centre) > 1"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'centre' tag shall appear only once. Check all 'time/centre' tags to find the
                duplicate tags. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="count(cda:width) > 1"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'width' tag shall appear only once. Check all 'time/width' tags to find the
                duplicate tags. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- The below 4 tests are superceded by the 'centre' tag test immediate followed. -->
            <!--
            <report test="cda:low and cda:width and (cda:high or cda:centre)"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time' tag shall have 'low' and 'width' without 'high or centre' tags.
                Check all 'time/low' and 'time/width' tags to find the
                incorrect use of tags. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:high and cda:width and (cda:low or cda:centre)"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time' tag shall have 'high' and 'width' without 'low or centre' tags.
                Check all 'time/high' and 'time/width' tags to find the
                incorrect use of tags. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:low and cda:high and (cda:centre or cda:width)"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time' tag shall have 'low' and 'high' without 'centre or width' tags.
                Check all 'time/low' and 'time/high' tags to find the
                incorrect use of tags. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:centre and cda:width and (cda:low or cda:high)"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time' tag shall have 'low' and 'high' without 'centre or width' tags.
                Check all 'time/low' and 'time/high' tags to find the
                incorrect use of tags. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>
            -->

            <!-- The 'centre' tag is used with 'width' tag, but should not be coexist with 'low' or 'high' tag -->

            <report test="cda:center and (cda:low or cda:high)"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time' tag shall have 'center' or 'low and/or high' tag but not both.
                Check all 'time' tags to find the incorrect use of 'centre' tag.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!--The period of time pattern is defined in terms of both of its lowest and highest values.
                we need to ensure value in low is not greater than value in high -->

            <!-- check value of time with fraction of seconds, with '+' timezone
                 'YYYYMMDDHHMMSS.UUUU+ZZzz'
                  ^^^^^^^^^^^^^^^^^^^                                        -->
            <report test="
                cda:low  and cda:low/@value            and
                cda:high and cda:high/@value           and
                normalize-space(cda:low/@value)  != '' and
                normalize-space(cda:high/@value) != '' and
                contains(cda:low/@value,'.')           and
                contains(cda:high/@value, '.')         and
                contains(cda:low/@value,'+')           and
                contains(cda:high/@value, '+')         and
                (number(substring-before(cda:low/@value,'.')) +
                number(substring-after(substring-before(cda:low/@value,'+'),'.')) >
                number(substring-before(cda:high/@value,'.')) +
                number(substring-after(substring-before(cda:high/@value,'+'),'.')))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'low' tag 'value' attribute shall contain a value less than than the
                'high' tag 'value' attribute. Check all 'time/low' and 'time/high' tags to find
                the incorrect attribute. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- check value of time with fraction of seconds, with '-' timezone
                 'YYYYMMDDHHMMSS.UUUU-ZZzz'
                  ^^^^^^^^^^^^^^^^^^^                                        -->
            <report test="
                cda:low  and cda:low/@value            and
                cda:high and cda:high/@value           and
                normalize-space(cda:low/@value)  != '' and
                normalize-space(cda:high/@value) != '' and
                contains(cda:low/@value,'.')           and
                contains(cda:high/@value, '.')         and
                contains(cda:low/@value,'-')           and
                contains(cda:high/@value, '-')         and
                (number(substring-before(cda:low/@value,'.')) +
                number(substring-after(substring-before(cda:low/@value,'-'),'.')) >
                number(substring-before(cda:high/@value,'.')) +
                number(substring-after(substring-before(cda:high/@value,'-'),'.')))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'low' tag 'value' attribute shall contain a value less than than the
                'high' tag 'value' attribute. Check all 'time/low' and 'time/high' tags to find
                the incorrect attribute. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- check value of time without fraction of seconds, with '+' timezone
                 'YYYYMMDDHHMM+ZZzz' or 'YYYYMMDDHHMMSS+ZZzz'
                  ^^^^^^^^^^^^           ^^^^^^^^^^^^^^                         -->
            <report test="
                cda:low  and cda:low/@value            and
                cda:high and cda:high/@value           and
                normalize-space(cda:low/@value)  != '' and
                normalize-space(cda:high/@value) != '' and
                contains(cda:low/@value, '+')          and
                contains(cda:high/@value,'+')          and
                (number(substring-before(cda:low/@value,'+')) > number(substring-before(cda:high/@value,'+')))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'low' tag 'value' attribute shall contain a value less than than the
                'high' tag 'value' attribute. Check all 'time/low' and 'time/high' tags to find
                the incorrect attribute. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- check value of time without fraction of seconds, with '-' timezone
                 'YYYYMMDDHHMM-ZZzz' or 'YYYYMMDDHHMMSS-ZZzz'
                  ^^^^^^^^^^^^           ^^^^^^^^^^^^^^                         -->
            <report test="
                cda:low  and cda:low/@value            and
                cda:high and cda:high/@value           and
                normalize-space(cda:low/@value)  != '' and
                normalize-space(cda:high/@value) != '' and
                contains(cda:low/@value, '-')          and
                contains(cda:high/@value,'-')          and
                (number(substring-before(cda:low/@value,'-')) > number(substring-before(cda:high/@value,'-')))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'low' tag 'value' attribute shall contain a value less than than the
                'high' tag 'value' attribute. Check all 'time/low' and 'time/high' tags to find
                the incorrect attribute. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- check value of time without fraction of seconds, and without timezone
                 'YYYYMMDD'
                  ^^^^^^^^                                                         -->
            <report test="
                cda:low  and cda:low/@value            and
                cda:high and cda:high/@value           and
                normalize-space(cda:low/@value)  != '' and
                normalize-space(cda:high/@value) != '' and
                not(contains(cda:low/@value, '+'))     and
                not(contains(cda:high/@value,'+'))     and
                not(contains(cda:low/@value, '-'))     and
                not(contains(cda:high/@value,'-'))     and
                (number(cda:low/@value) > number(cda:high/@value))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'low' tag 'value' attribute shall contain a value less than than the
                'high' tag 'value' attribute. Check all 'time/low' and 'time/high' tags to find
                the incorrect attribute. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>


        <!--The period of time pattern is defined in terms of one or both of its lowest and highest values. More complex time period concepts can be expressed by combining a high, low, or centre element with a width element.-->

        <!--go to the low, high or centre tags with a time parent-->

        <rule context="
            cda:time/cda:low | cda:time/cda:high | cda:time/cda:centre |
            ext:time/cda:low | ext:time/cda:high | ext:time/cda:centre |
            cda:birthTime/cda:low | cda:birthTime/cda:high | cda:birthTime/cda:centre |
            ext:birthTime/cda:low | ext:birthTime/cda:high | ext:birthTime/cda:centre |
            cda:deceasedTime/cda:low | cda:deceasedTime/cda:high | cda:deceasedTime/cda:centre |
            ext:deceasedTime/cda:low | ext:deceasedTime/cda:high | ext:deceasedTime/cda:centre |
            cda:effectiveTime/cda:low | cda:effectiveTime/cda:high | cda:effectiveTime/cda:centre |
            ext:effectiveTime/cda:low | ext:effectiveTime/cda:high | ext:effectiveTime/cda:centre">

            <report test="
                ../@xsi:type and
                ../@xsi:type != 'TS' and
                ../@xsi:type != 'IVL_TS' and
                ../@xsi:type != 'PIVL_TS'"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time' tag 'xsi:type' attribute shall contain the value 'TS',
                'IVL_TS' or 'PIVL_TS'. Check all 'time' tags to find the attribute.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <assert test="@value"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute is
                missing. Check all 'time' tags to find the missing attribute.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="@value and normalize-space(@value) = ''"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall
                contain a value. Check all 'time' tags to find the missing attribute value.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- Any time that is more specific than a day SHALL include a timezone. -->
            <report
                test="@value                and
                string-length(@value) > 8   and
                not(contains(@value,'+'))   and not(contains(@value,'-'))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall contain a timezone value.
                "Any time that is more specific than a day SHALL include a timezone".
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- check value of time with fraction of seconds, with or without timezone
                 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                  ^^^^^^^^^^^^^^                                                    -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                not(contains(@value,'.'))    or
                ((string(number(substring-before(@value,'.'))) != string(number(@value))) and
                (string-length(substring-before(@value,'.')) = 14))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect DateTime - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check fraction of second value, with a '+' timezone
                 'YYYYMMDDHHMMSS.UUUU+ZZzz'
                                 ^^^^                            -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                not(contains(@value,'+'))    or
                not(contains(@value,'.'))    or
                ((string(number(substring-before(substring-after(@value,'.'),'+'))) != string(number(@value))) and
                (string-length(substring-before(substring-after(@value,'.'),'+')) = 4))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect fraction of second - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute
                shall be a number formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check fraction of second value, with a '-' timezone
                 'YYYYMMDDHHMMSS.UUUU-ZZzz'
                                 ^^^^                            -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                not(contains(@value,'-'))    or
                not(contains(@value,'.'))    or
                ((string(number(substring-before(substring-after(@value,'.'),'-'))) != string(number(@value))) and
                (string-length(substring-before(substring-after(@value,'.'),'-')) = 4))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect fraction of second - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute
                shall be a number formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of time without fraction of seconds, and with a '+' timezone
                 'YYYYMMDDHHMM+ZZzz' or 'YYYYMMDDHHMMSS+ZZzz'
                  ^^^^^^^^^^^^           ^^^^^^^^^^^^^^                               -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                contains(@value,'.')         or
                not(contains(@value,'+'))    or
                ((string(number(substring-before(@value,'+'))) != string(number(@value))) and
                (string-length(substring-before(@value,'+')) > 11) and
                (string-length(substring-before(@value,'+')) &lt; 15) and
                (string-length(substring-before(@value,'+')) mod 2 = 0))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect DateTime - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of time without fraction of seconds, and with a '-' timezone
                 'YYYYMMDDHHMM-ZZzz' or 'YYYYMMDDHHMMSS-ZZzz'
                  ^^^^^^^^^^^^           ^^^^^^^^^^^^^^                               -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                contains(@value,'.')         or
                not(contains(@value,'-'))    or
                ((string(number(substring-before(@value,'-'))) != string(number(@value))) and
                (string-length(substring-before(@value,'-')) > 11) and
                (string-length(substring-before(@value,'-')) &lt; 15) and
                (string-length(substring-before(@value,'-')) mod 2 = 0))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect DateTime - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of timezone with a '+' timezone
                 'YYYYMMDDHHMMSS.UUUU+ZZzz'
                                      ^^^^               -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                not(contains(@value,'+'))    or
                ((string(number(substring-after(@value,'+'))) != string(number(@value))) and
                ((string-length(substring-after(@value,'+')) = 2) or (string-length(substring-after(@value,'+')) = 4)))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect TimeZone - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of timezone with a '-' timezone
                 'YYYYMMDDHHMMSS.UUUU-ZZzz'
                                      ^^^^               -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                not(contains(@value,'-'))    or
                ((string(number(substring-after(@value,'-'))) != string(number(@value))) and
                ((string-length(substring-after(@value,'-')) = 2) or (string-length(substring-after(@value,'-')) = 4)))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect TimeZone - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of time without fraction of seconds, and without timezone (could safely assume year only)
                 'YYYYMMDD'
                  ^^^^                                                                                             -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                contains(@value,'.')         or
                contains(@value,'+')         or
                contains(@value,'-')         or
                ((string(number(@value)) != string(number('a'))) and
                (string-length(@value) >= 4))"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect DateTime - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of year, assume years from 19xx - XXxx
                 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                  ^^^^                                             -->
<!--
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                ((number(substring(@value,1,2)) >= 19) and
                (number(substring(@value,1,2)) &lt; 21))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Year - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>
-->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                number(substring(@value,1,2)) >= 19
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Year - The value for year must be more recent than 1900.
                The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of month, from 1 to 12
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                     ^^                                            -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                string-length(@value) &lt; 5 or
                ((number(substring(@value,5,2)) >= 1) and
                (number(substring(@value,5,2)) &lt; 13))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Month - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of date, month 1,3,5,7,8,10,12 shall be from 1 to 31
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                       ^^                                                     -->
            <assert test="
                not(@value)                           or
                normalize-space(@value) = ''          or
                string-length(@value) &lt; 7          or
                number(substring(@value,5,2)) = 2     or
                number(substring(@value,5,2)) = 4     or
                number(substring(@value,5,2)) = 6     or
                number(substring(@value,5,2)) = 9     or
                number(substring(@value,5,2)) = 11    or
                number(substring(@value,5,2)) > 12    or
                ((number(substring(@value,7,2)) >= 1) and
                (number(substring(@value,7,2)) &lt; 32))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Date - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of date, month 4,6,9,11 shall be from 1 to 30
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                       ^^                                              -->
            <assert test="
                not(@value)                           or
                normalize-space(@value) = ''          or
                string-length(@value) &lt; 7          or
                number(substring(@value,5,2)) = 1     or
                number(substring(@value,5,2)) = 2     or
                number(substring(@value,5,2)) = 3     or
                number(substring(@value,5,2)) = 5     or
                number(substring(@value,5,2)) = 7     or
                number(substring(@value,5,2)) = 8     or
                number(substring(@value,5,2)) = 10    or
                number(substring(@value,5,2)) = 12    or
                number(substring(@value,5,2)) > 12    or
                ((number(substring(@value,7,2)) >= 1) and
                (number(substring(@value,7,2)) &lt; 31))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Month - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of date, month 2 shall be from 1 to 29 if leap year
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                       ^^                                                    -->
            <assert test="
                not(@value)                           or
                normalize-space(@value) = ''          or
                string-length(@value) &lt; 7          or
                number(substring(@value,5,2)) = 1     or
                number(substring(@value,5,2)) = 3     or
                number(substring(@value,5,2)) = 4     or
                number(substring(@value,5,2)) = 5     or
                number(substring(@value,5,2)) = 6     or
                number(substring(@value,5,2)) = 7     or
                number(substring(@value,5,2)) = 8     or
                number(substring(@value,5,2)) = 9     or
                number(substring(@value,5,2)) = 10    or
                number(substring(@value,5,2)) = 11    or
                number(substring(@value,5,2)) = 12    or
                number(substring(@value,5,2)) > 12    or
                (number(substring(@value,1,4)) mod 4) != 0 or
                ((number(substring(@value,7,2)) >= 1) and
                (number(substring(@value,7,2)) &lt; 30))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Date - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of date, month 2 shall be from 1 to 28 if not leap year
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                       ^^                                                        -->
            <assert test="
                not(@value)                           or
                normalize-space(@value) = ''          or
                string-length(@value) &lt; 7          or
                number(substring(@value,5,2)) = 1     or
                number(substring(@value,5,2)) = 3     or
                number(substring(@value,5,2)) = 4     or
                number(substring(@value,5,2)) = 5     or
                number(substring(@value,5,2)) = 6     or
                number(substring(@value,5,2)) = 7     or
                number(substring(@value,5,2)) = 8     or
                number(substring(@value,5,2)) = 9     or
                number(substring(@value,5,2)) = 10    or
                number(substring(@value,5,2)) = 11    or
                number(substring(@value,5,2)) = 12    or
                number(substring(@value,5,2)) > 12    or
                (number(substring(@value,1,4)) mod 4) = 0 or
                ((number(substring(@value,7,2)) >= 1) and
                (number(substring(@value,7,2)) &lt; 29))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Date - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of hour, from 0 to 23
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                         ^^                                        -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                string-length(substring-before(translate(@value, '-', '+'),'+')) &lt; 9 or
                ((number(substring(@value,9,2)) >= 0) and
                (number(substring(@value,9,2)) &lt; 24))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Hour - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of minute, from 0 to 59
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                           ^^                                      -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                string-length(substring-before(translate(@value, '-', '+'),'+')) &lt; 11 or
                ((number(substring(@value,11,2)) >= 0) and
                (number(substring(@value,11,2)) &lt; 60))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Minute - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- check value of second, from 0 to 59
                'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'
                             ^^                                    -->
            <assert test="
                not(@value)                  or
                normalize-space(@value) = '' or
                string-length(substring-before(translate(@value, '-', '+'),'+')) &lt; 13 or
                ((number(substring(@value,13,2)) >= 0) and
                (number(substring(@value,13,2)) &lt; 60))
                "
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - Incorrect Second - The 'time/low' or 'time/high' or 'time/centre' tag 'value' attribute shall be a number
                formatted as 'YYYYMMDDHHMMSS.UUUU[+|-ZZzz]'. Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

        </rule>


        <rule context="
            cda:time/cda:width |
            ext:time/cda:width |
            cda:birthTime/cda:width |
            ext:birthTime/cda:width |
            cda:deceasedTime/cda:width |
            ext:deceasedTime/cda:width |
            cda:effectiveTime/cda:width |
            ext:effectiveTime/cda:width">

            <report test="
                ../@xsi:type and
                ../@xsi:type != 'TS' and
                ../@xsi:type != 'IVL_TS' and
                ../@xsi:type != 'PIVL_TS'"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time' tag 'xsi:type' attribute shall contain the value 'TS',
                'IVL_TS' or 'IVL_TS'. Check all 'time' tags to find the attribute.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <assert test="@value"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time/width' tag 'value' attribute is missing.
                Check all 'time/width' tags to find the missing attribute.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="@value and normalize-space(@value) = ''"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time/width' tag 'value' attribute shall contain a value.
                Check all 'time/width' tags to find the missing value.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@unit and normalize-space(@unit) = ''"
                >Error: e-Referral - Global Clinical Document check for "time"
                tag - The 'time/width' tag 'unit' attribute shall contain a value.
                Check all 'time/width' tags to find the missing value.
                Refer to section 8.3 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>





        <!-- BEGIN :: Common Patterns: 8.4 ENTITY IDENTIFIER -->

        <rule context="ext:asEntityIdentifier">

            <!-- asEntityIdentifier/@classCode -->
            <!--the cardinality of the children data elements comes from the R-MIM diagram.-->

            <assert test="@classCode">Error: e-Referral -
                Global Clinical Document check for "ext:asEntityIdentifier" tag -
                The 'ext:asEntityIdentifier' tag 'classCode' attribute is missing.
                Check all 'ext:asEntityIdentifier' tags to find the missing 'classCode' attribute.
                Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="not(@classCode) or normalize-space(@classCode) != ''">Error: e-Referral -
                Global Clinical Document check for "ext:asEntityIdentifier" tag -
                The 'ext:asEntityIdentifier' tag 'classCode' attribute shall contain a value.
                Check all 'ext:asEntityIdentifier' tags to find the missing 'classCode' attribute.
                Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="
                not(@classCode) or
                normalize-space(@classCode) = '' or
                @classCode='IDENT'"
                >Error: e-Referral -
                Global Clinical Document check for "ext:asEntityIdentifier" tag -
                The 'ext:asEntityIdentifier' tag 'classCode' attribute shall be 'IDENT'.
                Check all 'ext:asEntityIdentifier' tags to find the incorrect 'classCode' attribute.
                Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>


            <!-- id - 1..1 -->
            <!--All R-MIM diagrams show id as 1..1-->

            <assert test="ext:id">Error: e-Referral -
                Global Clinical Document check for "ext:asEntityIdentifier/ext:id" tag -
                The 'ext:id' tag is missing. Check all "ext:asEntityIdentifier' tags to find
                the missing 'id' tag. Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="count(ext:id) > 1"
                >Error: e-Referral -
                Global Clinical Document check for 'ext:asEntityIdentifier/ext:id' tag -
                The 'id' tag shall appear only once.
                Check all 'ext:asEntityIdentifier' tags to find the duplicate 'id' tag.
                Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- Mantis 2584: Attribute ext:id/@assigningAuthorityName SHOULD be used, and it is recommended only (optional) -->
            <!--
            <assert test="ext:id/@assigningAuthorityName">Error: e-Referral -
                Global Clinical Document check for "ext:id" tag -
                The 'ext:id' tag 'assigningAuthorityName' attribute is missing. Check all
                "ext:asEntityIdentifier' tags to find the 'id' tag with the missing
                'assigningAuthorityName' attribute. Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>
            -->

            <!-- Other attributes of "ext:id" are being tested by e-Referral_Global_Checks.sch. -->


            <!-- code - 0..1 -->

            <report test="count(ext:code) > 1"
                >Error: e-Referral -
                Global Clinical Document check for 'ext:asEntityIdentifier/ext:code' tag -
                The 'ext:code' tag shall appear only once. Check all 'ext:asEntityIdentifier' tag
                to find the duplicate 'code' tag. Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- The attributes of "ext:code" (code, codeSystem, codeSystemName, displayName) are being tested by e-Referral_Global_Checks.sch. -->


            <!-- assigningGeographicArea - 0..1 -->

            <report test="count(ext:assigningGeographicArea) > 1"
                >Error: e-Referral -
                Global Clinical Document check for 'ext:asEntityIdentifier/ext:assigningGeographicArea' tag -
                The 'assigningGeographicArea' tag shall appear only once. Check all
                'ext:assigningGeographicArea' tags to find the duplicate 'assigningGeographicArea'
                tag. Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>


        <rule context="ext:assigningGeographicArea">

            <assert test="@classCode"
                >Error: e-Referral - Global Clinical Document check for
                "ext:asEntityIdentifier/ext:assigningGeographicArea" tag -
                The 'assigningGeographicArea' tag 'classCode' attribute is missing.
                Check all 'ext:asEntityIdentifier/ext:assigningGeographicArea' tags to find the missing 'classCode' attribute.
                Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="not(@classCode) or normalize-space(@classCode) != ''"
                >Error: e-Referral - Global Clinical Document check for
                "ext:asEntityIdentifier/ext:assigningGeographicArea" tag -
                The 'assigningGeographicArea' tag 'classCode' attribute shall contain a value.
                Check all 'ext:asEntityIdentifier/ext:assigningGeographicArea' tags to find the missing 'classCode' attribute.
                Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="
                not(@classCode) or
                normalize-space(@classCode) = '' or
                @classCode='PLC'"
                >Error: e-Referral - Global Clinical Document check for
                "ext:asEntityIdentifier/ext:assigningGeographicArea" tag -
                The 'assigningGeographicArea' tag 'classCode' attribute shall be 'PLC'. Check all
                'ext:asEntityIdentifier/ext:assigningGeographicArea' tags to find the incorrect 'classCode' attribute.
                Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- ext:name - 0..1 -->

            <report test="ext:name and normalize-space(ext:name) = ''"
                >Error: e-Referral - Global Clinical Document check for
                "ext:asEntityIdentifier/ext:assigningGeographicArea" tag - The 'name'
                tag shall contain a value. Check all 'ext:name' tag to find the missing value.
                Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="
                ext:name and
                normalize-space(ext:name) != '' and
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'AS_5017-2006_Health_Care_Client_Identifier_Geographic_Area']
                /code[translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') =
                translate(current()/ext:name, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')])"
                >Error: e-Referral - Global Clinical Document check for
                "ext:asEntityIdentifier/ext:assigningGeographicArea" tag - The 'name'
                tag shall be as per AS 5017-2006: Health Care Client Identifier
                Geographic Area. It shall be the range and extent that the identifier applies to
                the object with which it is associated that is populated directly from the
                geographic area. This shall NOT be used for machine readability purposes.
                Check all 'ext:name' tag to find the incorrect value.
                Refer to section 8.4 Entity Identifier of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>




        <!-- BEGIN :: Common Patterns: 8.5 PERSON NAME -->

        <rule context="cda:name[not(
                      ancestor::cda:manufacturedMaterial or
                      ancestor::cda:product or
                      ancestor::cda:receivedOrganization or
                      ancestor::cda:representedOrganization or
                      ancestor::cda:representedCustodianOrganization or
                      ancestor::cda:scopingOrganization or
                      ancestor::cda:serviceProviderOrganization or
                      ancestor::cda:targetSiteCode or
                      ancestor::ext:employerOrganization)]">

            <!-- either it's structured name or not. If it's not structured, it must have some text but no children elements -->
            <assert test="
                (child::* and normalize-space(concat(text()[1], text()[2], text()[3], text()[4], text()[5])) = '') or
                (not(child::*) and normalize-space(.) != '')"
                >Error: e-Referral -
                Global Clinical Document check for "name" tag - The 'name' tag shall have
                either a 'structured name' or an 'unstructured name' presented but not both.
                Check all 'cda:name' tags to find the incorrect 'name' tag.
                Refer to section 8.5 Person Name of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- prefix - 0..* -->

            <report test="cda:prefix and normalize-space(cda:prefix ) = ''"
                >Error: e-Referral -
                Global Clinical Document check for "name" tag - The 'prefix' tag
                shall contain a value. Check all 'cda:name/cda:prefix' tags to find the missing
                value. Refer to section 8.5 Person Name of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- family - 1..1 when structured name is used -->

            <!-- If it's structured name, it's got to have a family name. -->
            <assert test="cda:family or normalize-space(concat(text()[1], text()[2], text()[3], text()[4], text()[5])) != ''"
                >Error: e-Referral -
                Global Clinical Document check for "name" tag - The 'family' tag is missing.
                Check all 'cda:name' tags to find the missing 'family' child tag.
                Refer to section 8.5 Person Name of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="count(cda:family) > 1"
                >Error: e-Referral -
                Global Clinical Document check for "name" tag - The 'family' tag
                shall appear only once. Check all 'cda:name' tags to find the duplicate 'family'
                child tag. Refer to section 8.5 Person Name of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <assert test="not(cda:family) or normalize-space(cda:family) !=  ''"
                >Error: e-Referral -
                Global Clinical Document check for "name" tag - The 'family' tag
                shall contain a value. Check all 'cda:name/cda:family' tags to find the missing
                value. Refer to section 8.5 Person Name of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <!-- given - 0..* -->

            <report test="cda:given and normalize-space(cda:given) = ''"
                >Error: e-Referral -
                Global Clinical Document check for "name" tag - The 'given' tag
                shall contain a value. Check all 'cda:name/cda:given' tags to find the missing
                value. Refer to section 8.5 Person Name of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- suffix - 0..* -->

            <report test="cda:suffix and normalize-space(cda:suffix) = ''"
                >Error: e-Referral -
                Global Clinical Document check for "name" tag - The 'suffix' tag
                shall contain a value. Check all 'cda:name/cda:suffix' tags to find the missing
                value. Refer to section 8.5 Person Name of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @use is optional, it also can exist and be blank -->

            <!-- @use exist, and @use not blank, and @use not contains space(single use code), and @use is not in vocab -->
            <report
                test="@use and
                normalize-space(@use) != '' and
                not(contains(@use, ' ')) and
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Name_Usage']/code[
                    (@code = (current()/@use)) or
                    (@alternativeCode = (current()/@use)) or
                    (@hl7Code  = (current()/@use))
                ])"
                >Error: e-Referral -
                Global Clinical Document check for "name" tag - The 'name' tag
                'use' attribute shall be coded as per AS 5017-2006: Health Care
                Client Name Usage. Check all 'cda:name' tags to find the incorrect 'use'
                attribute. Refer to section 8.5 Person Name of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @use exist, and @use not blank, and @use contains one space(two use codes), and at least first or second use code is not in vocab -->
            <report test="
                @use and
                normalize-space(@use) != '' and
                contains(@use, ' ') and
                not(contains(substring-after(@use, ' '), ' ')) and (
                    not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Name_Usage']/code[
                        (@code = substring-before(current()/@use,' ')) or
                        (@alternativeCode = substring-before(current()/@use,' ')) or
                        (@hl7Code = substring-before(current()/@use,' '))
                    ]) or
                    not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Name_Usage']/code[
                        (@code = substring-after(current()/@use,' ')) or
                        (@alternativeCode = substring-after(current()/@use,' ')) or
                        (@hl7Code = substring-after(current()/@use,' '))
                    ])
                )"
                >Error: e-Referral -
                Global Clinical Document check for "name" tag - The 'name' tag
                'use' attribute shall be coded as per AS 5017-2006: Health Care
                Client Name Usage. Check all 'cda:name' tags to find the incorrect 'use'
                attribute. Refer to section 8.5 Person Name of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @use exist, and @use not blank, and @use contains two space(three use codes), and at least one of the three use code is not in vocab -->
            <report test="
                @use and
                normalize-space(@use) != '' and
                contains(@use, ' ') and
                not(contains(substring-after(substring-after(@use, ' '), ' '), ' ')) and (
                    not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Name_Usage']/code[
                        (@code = substring-before(current()/@use,' ')) or
                        (@alternativeCode = substring-before(current()/@use,' ')) or
                        (@hl7Code = substring-before(current()/@use,' '))
                    ]) or
                    not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Name_Usage']/code[
                        (@code = substring-before(substring-after(current()/@use,' '),' ')) or
                        (@alternativeCode = substring-before(substring-after(current()/@use,' '),' ')) or
                        (@hl7Code = substring-before(substring-after(current()/@use,' '),' '))
                    ]) or
                    not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Name_Usage']/code[
                        (@code = substring-after(substring-after(current()/@use,' '),' ')) or
                        (@alternativeCode = substring-after(substring-after(current()/@use,' '),' ')) or
                        (@hl7Code = substring-after(substring-after(current()/@use,' '),' '))
                    ])
                )"
                >Error: e-Referral -
                Global Clinical Document check for "name" tag - The 'name' tag
                'use' attribute shall be coded as per AS 5017-2006: Health Care
                Client Name Usage. Check all 'cda:name' tags to find the incorrect 'use'
                attribute. Refer to section 8.5 Person Name of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>




        <!-- BEGIN :: Common Patterns: 8.6 ADDRESS -->

        <rule context="cda:addr[not(ancestor::cda:birthplace)]">

            <!-- streetAddressLine (International or Australian) -  0..* -->

            <report test="cda:streetAddressLine and normalize-space(cda:streetAddressLine) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address /
                Australian Address / Unstructured Australian Address Line" or
                "Address / Australian or International Address /
                International Address / International Address Line" -
                The 'streetAddressLine' tag shall contain a value. Check all 'cda:addr' tags to
                find the incorrect 'streetAddressLine' tag. Refer to section 8.6 Address of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- unitType -  0..1 -->

            <report test="count(cda:unitType) > 1"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Unit Type" -
                The 'unitType' tag shall appear only once. Check all 'cda:addr' tags
                to find the duplicate 'unitType' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="
                (not(cda:country) or document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'ISO3166-1']
                /code[translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') =
                translate(current()/cda:country, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')]/@code = 'AU') and
                cda:unitType and
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Australian_Unit_Type']/code[@code = current()/cda:unitType])"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Unit Type" -
                The 'unitType' tag shall contain values coded as per 'AS 4846-2006' -
                Healthcare Provider Identification: Australian Unit Type.
                Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- unitID -  0..1 -->

            <report test="count(cda:unitID) > 1"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Unit Number" -
                The 'unitID' tag shall appear only once. Check all 'cda:addr' tags to find
                the duplicate 'unitID' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:unitID and normalize-space(cda:unitID) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Unit Number" -
                The 'unitID' tag shall contain a value. Check all 'cda:addr' tags to find the
                empty 'unitID' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- additionalLocator -  0..1 -->

            <report test="count(cda:additionalLocator) > 5"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Address Site Name" and/or
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Level Type" and/or
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Level Number" and/or
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Lot Number" and/or
                "Address / Australian or International Address / Australian Address /
                Australian Delivery Point Identifier".
                The 'additionalLocator' tag shall appear only 5 times. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:additionalLocator and normalize-space(cda:additionalLocator) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Address Site Name" and/or
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Level Type" and/or
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Level Number" and/or
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Lot Number" and/or
                "Address / Australian or International Address / Australian Address /
                Australian Delivery Point Identifier".
                The 'additionalLocator' tag shall contain a value. Check all 'cda:addr' tags
                to find the empty 'additionalLocator' tag(s). Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- houseNumber -  0..1 -->

            <report test="count(cda:houseNumber) > 1"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Street Number" -
                The 'houseNumber' tag shall appear only once. Check all 'cda:addr' tags to
                find the duplicate 'houseNumber' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:houseNumber and normalize-space(cda:houseNumber) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Street Number" -
                The 'houseNumber' tag shall contain a value. Check all 'cda:addr' tags to find
                the empty 'houseNumber' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- streetName -  0..1 -->

            <report test="count(cda:streetName) > 1"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Street Name" -
                The 'streetName' tag shall appear only once. Check all 'cda:addr' tags to
                find the duplicate 'streetName' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:streetName and normalize-space(cda:streetName) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Street Name" -
                The 'streetName' tag shall contain a value. Check all 'cda:addr' tags
                to find the empty 'streetName' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- streetNameType -  0..1 -->

            <report test="count(cda:streetNameType) > 1"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Street Type" -
                The 'streetNameType' tag shall appear only once. Check all 'cda:addr' tags
                to find the duplicate 'streetNameType' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:streetNameType and normalize-space(cda:streetNameType) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Street Type" -
                The 'streetNameType' tag shall contain a value. Check all 'cda:addr' tags
                to find the empty 'streetNameType' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- comment out as per MANTIS 1753 until there is a complete set of street name type reference in our vocab file -->
            <!--
            <report test="
                (not(cda:country) or document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'ISO3166-1']
                /code[translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') =
                translate(current()/cda:country, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')]/@code = 'AU') and
                cda:streetNameType and
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Australian_Street_type_Code']/code[@code = current()/cda:streetNameType]) and
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Australian_Street_type_Code']
                /code[translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') =
                translate(current()/cda:streetNameType, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')])"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Street Type" -
                The 'streetNameType' tag shall contain values coded as per 'AS 4846-2006' -
                Healthcare Client Identification: Australian Street Type Code.
                Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>
            -->
            <!-- comment out until there is a complete set of street name type reference in our vocab file -->

            <!-- direction -  0..1 -->

            <report test="count(cda:direction) > 1"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Street Suffix" -
                The 'direction' tag shall appear only once. Check all 'cda:addr' tags to
                find the duplicate 'direction' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="
                (not(cda:country) or document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'ISO3166-1']
                /code[translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') =
                translate(current()/cda:country, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')]/@code = 'AU') and
                cda:direction and
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Australian_Street_Suffix_Code']/code[@code = current()/cda:direction])"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Street Suffix" -
                The 'direction' tag shall contain values coded as per 'AS 4846-2006' -
                Healthcare Client Identification: Australian Street Suffix.
                Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- deliveryAddressLine -  0..1 -->

            <report test="count(cda:deliveryAddressLine) > 2"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Postal Delivery Type" and/or
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Postal Delivery Number" -
                The 'deliveryAddressLine' tag shall appear only twice. Check all 'cda:addr' tags
                to find the excessive 'deliveryAddressLine' tag(s). Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report
                test="
                cda:deliveryAddressLine and normalize-space(cda:deliveryAddressLine[1]) = '' or
                count(cda:deliveryAddressLine) > 1 and normalize-space(cda:deliveryAddressLine[2]) = ''
                "
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Postal Delivery Type" and/or
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Postal Delivery Number" -
                The 'deliveryAddressLine' tag shall contain a value. Check all 'cda:addr' tags
                to find the empty 'deliveryAddressLine' tag(s). Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- One of the deliveryAddressLine must be Australian Postal Delivery Type Code (not both) if present -->
            <report test="
                (not(cda:country) or document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'ISO3166-1']
                /code[translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') =
                translate(current()/cda:country, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')]/@code = 'AU') and
                cda:deliveryAddressLine and
                normalize-space(cda:deliveryAddressLine) != '' and
                count(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Australian_Postal_Delivery_Type_Code']/code[@code = current()/cda:deliveryAddressLine]) != 1
                "
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Postal Delivery Type" and/or
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Postal Delivery Number" -
                The 'deliveryAddressLine' tag shall contain values coded as per 'AS 5017-2006' -
                Healthcare Client Identification: Australian Postal Delivery Type Code.
                Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- Must have Australian Postal Delivery Number if Australian Postal Delivery Type Code is NOT any of 'Care PO', 'CMA', 'CMB' and 'CPA' -->
            <report test="
                (not(cda:country) or document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'ISO3166-1']
                /code[translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') =
                translate(current()/cda:country, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')]/@code = 'AU') and
                cda:deliveryAddressLine and
                normalize-space(cda:deliveryAddressLine) != '' and
                count(cda:deliveryAddressLine) = 1 and
                count(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Australian_Postal_Delivery_Type_Code']/code[@code = current()/cda:deliveryAddressLine]) = 1 and
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Australian_Postal_Delivery_Number']/code[@code = current()/cda:deliveryAddressLine])
                "
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Postal Delivery Type" and/or
                "Address / Australian or International Address / Australian Address /
                Structured Australian Address Line / Australian Postal Delivery Number" -
                The 'deliveryAddressLine(Australian_Postal_Delivery_Number)' tag is missing for
                the given 'deliveryAddressLine(Australian_Postal_Delivery_Type_Code)'.
                The 'deliveryAddressLine' tag(s) shall contain values coded as per 'AS 5017-2006' -
                Healthcare Client Identification: Australian Postal Delivery Type Code.
                Check all 'cda:addr' tags to find the non-conforming 'devliveryAddressLine' tag.
                Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- city -  0..1 -->

            <report test="count(cda:city) > 1"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address/ Australian or International Address / Australian Address /
                Australian Suburb/Town/Locality" -
                The 'city' tag shall appear only once. Check all 'cda:addr' tags to find the
                duplicate 'city' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:city and normalize-space(cda:city) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address/ Australian or International Address / Australian Address /
                Australian Suburb/Town/Locality" -
                The 'city' tag shall contain a value. Check all 'cda:addr' tags to find the
                empty 'city' tag. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- state -  0..1 -->

            <report test="count(cda:state) > 1"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Australian State/Territory" -
                The 'state' tag shall appear only once. Check all 'cda:addr' tags to find
                the duplicate 'state' tag. Refer to section 8.6 and 10.10 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="
                (not(cda:country) or document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'ISO3166-1']
                /code[translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') =
                translate(current()/cda:country, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')]/@code = 'AU') and
                cda:state and
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Australian_State_Territory_Identifier_-_Postal']/code[@code = current()/cda:state])"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / Australian Address /
                Australian State/Territory" - The 'state' tag shall be as per 'AS 5017-2006' -
                Australian State/Territory Identifier - Postal. Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="
                (not(cda:country) or document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'ISO3166-1']
                /code[translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') =
                translate(current()/cda:country, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')]/@code = 'AU') and
                cda:state and
                normalize-space(cda:state) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / International Address /
                International State/Province" -
                The 'state' tag shall contain a value. Check all 'cda:addr' tags to find the empty
                'state' tag(s). Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- postalCode -  0..1 -->

            <report test="count(cda:postalCode) > 1"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address/ Australian or International Address / Australian Address /
                Australian Postcode" - The 'postalCode' tag shall appear only once.
                Check all 'cda:addr' tags to find the duplicate 'postalCode' tag.
                Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:postalCode and normalize-space(cda:postalCode) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address/ Australian or International Address / Australian Address /
                Australian Postcode" - The 'postalCode' tag shall contain a value.
                Check all 'cda:addr' tags to find the empty 'postalCode' tag.
                Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- country - 0..1 -->

            <report test="count(cda:country) > 1"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / International Address / Country" -
                The 'country' tag shall appear only once. Check all 'cda:addr' tags to find
                the duplicate 'country' tag. Refer to section 8.6 Address of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="cda:country and normalize-space(cda:country) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / International Address / Country" -
                The 'country' tag shall contain a value. Check all 'cda:addr' tags to find the
                empty 'country' tag. Refer to section 8.6 Address of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report
                test="cda:country and not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'ISO3166-1']
                /code[translate(@displayName, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') =
                translate(current()/cda:country, 'abcdefghijklmnopqrstuvwxyz', 'ABCDEFGHIJKLMNOPQRSTUVWXYZ')])"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Australian or International Address / International Address / Country" -
                The 'country' tag shall contain values coded as per Australia Bureau of Statistics,
                Standard Australian Classification of Countries (SACC) Cat. No. 1269.
                Refer to section 8.6 Address of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>


            <!-- @use xor @nullFlavor='NA' - 1..1 -->
            <!-- Mandatory in the sense that either of @use or @nullFlavor='NA' shall appear, but not both -->

            <!-- 0004359: CV, PPR, PDR, MIV :: Schematrons should not produce an error where there is no use or nullflavor specified for addr -->
            <!-- 0004359:  ... -->
            <!-- 0004359: @use can be optional and can be empty -->
            <!-- 0004359:  ... -->
            <!-- 0004359: @use attribute can be space separated list of codes.
                          See C:\CCA\CDAValidate\Reference Documents\Address - use - space separated list of codes.xlsx -->
            <!-- 0004359: If @use is used it shall only contain the values from the column "HL7 Address Use Code" (restricted by schema) -->
            <!-- 0004359:  ... -->
            <!-- 0004359: @nullFlavor can be optional and cannot be empty -->
            <!-- 0004359: both @use and @nullFlavor can co-exist -->

            <!-- 0004359: addr must have one or more of: nullFlavor, or some text, or some child tag (streetAddressLine etc).
                          - some text means it can be like <addr>xyz</addr>,
                          and some parts mean it shall have one of the child tags streetAddressLine, unitType or streetNameType etc, -->

            <!-- 0004359: both @use and @nullFlavor can co-exist -->
<!--
            <assert test="(@use and not(@nullFlavor)) or (not(@use) and @nullFlavor)"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Address Purpose" and "Address / No Fixed Address Indicator" -
                The 'addr' tag shall have 'use' or 'nullFlavor' attributes but not both.
                Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>
-->
            <!-- @nullFlavor -->

            <report test="@nullFlavor and normalize-space(@nullFlavor) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Address Purpose" and "Address / No Fixed Address Indicator" -
                The 'addr' tag 'nullFlavor' attribute shall contain a value.
                Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <report test="@nullFlavor and normalize-space(@nullFlavor) != '' and @nullFlavor != 'NA'"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Address Purpose" and "Address / No Fixed Address Indicator" -
                The 'addr' tag 'nullFlavor' attribute shall contain the value 'NA'.
                Refer to section 8.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @use -->
            <!-- 0004359: @use can be optional and can be empty -->
<!--
            <report test="
                @use and normalize-space(@use) = ''"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Address Purpose" -
                The 'addr' tag 'use' attribute shall contain a value. Refer to section 8.6 and 10.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>
-->

            <report test="
                @use and
                normalize-space(@use) != '' and
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Identifier_Address_Purpose']/code[
                (@code            = current()/@use) or
                (@alternativeCode = current()/@use) or
                (@hl7Code         = current()/@use)])"
                >Error: e-Referral - Global Clinical Document check for 'addr' tag -
                "Address / Address Purpose" -
                The 'addr' tag 'use' attribute shall be coded as per 'AS 5017-2006' -
                Health Care Client Identifier Address Purpose. Refer to section 8.6 and 10.6 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>




        <!-- BEGIN :: Common Patterns: 8.7 ELECTRONIC COMMUNICATION DETAIL -->

        <rule context="cda:telecom">

            <assert test="@value or @nullFlavor"
                >Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Medium or Electronic Communication Address" -
                The 'telecom' tag shall have 'value' or 'nullFlavor' attribute.
                Check all 'cda:telecom' tags 'value' or 'nullFlavor' attributes to find
                the missing value. Refer to section 8.7 Electronic Communication Detail of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="not(@value) or normalize-space(@value) !=''"
                >Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Medium or Electronic Communication Address" -
                The 'telecom' tag 'value' attribute shall contain a value.
                Check all 'cda:telecom' tags 'value' attributes to find the missing value.
                Refer to 8.7 Electronic Communication Detail of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="not(@nullFlavor) or normalize-space(@nullFlavor) !=''"
                >Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Medium or Electronic Communication Address" -
                The 'telecom' tag 'nullFlavor' attribute shall contain a value.
                Check all 'cda:telecom' tags 'nullFlavor' attributes to find the missing value.
                Refer to 8.7 Electronic Communication Detail of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="not(@value) or contains(@value,':')"
                >Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Medium or Electronic Communication Address" -
                The 'telecom' tag 'value' attribute shall contain a ":".
                Check all 'cda:telecom' tags 'value' attributes to find the incorrect value.
                Refer to 8.7 Electronic Communication Detail of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <assert test="
                not(@value) or
                document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Electronic_Communication_Medium']/code[
                    (@code            = substring-before(current()/@value,':')) or
                    (@alternativeCode = substring-before(current()/@value,':')) or
                    (@hl7Code         = substring-before(current()/@value,':'))
                ]
                ">Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Medium or Electronic Communication Address" -
                The 'telecom' tag 'value' attribute shall be as per AS 5017-2006:
                Health Care Client Electronic Communication Medium.
                Check all 'cda:telecom' tags 'value' attributes to find the incorrect value.
                Refer to section 8.7 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</assert>

            <report test="
                @use and normalize-space(@use) = ''
                ">Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Usage Code" - The 'telecom' tag 'use' attribute shall
                contain a value. Check all 'cda:telecom' tags 'use'
                attributes to find the incorrect value. Refer to section 8.7 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @use exist, and @use not contains space(single use code), and @use is not in vocab -->
            <report test="
                @use and normalize-space(@use) != '' and
                not(contains(@use, ' ')) and
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'TelecommunicationAddressUse']/code[(@code = current()/@use)])
                ">Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Usage Code" - The 'telecom' tag 'use' attribute shall
                be as per HL7 v3: TelecommunicationAddressUse. Check all 'cda:telecom' tags 'use'
                attributes to find the incorrect value. Refer to section 8.7 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @use exist, and @use contains one space(two use codes), and at least first or second use code is not in vocab -->
            <report test="
                @use and normalize-space(@use) != '' and
                contains(@use, ' ') and
                not(contains(substring-after(@use, ' '), ' ')) and (
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'TelecommunicationAddressUse']/code[(@code = substring-before(current()/@use,' '))]) or
                not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'TelecommunicationAddressUse']/code[(@code = substring-after(current()/@use,' '))])
                )">Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Usage Code" - The 'telecom' tag 'use' attribute shall
                be as per HL7 v3: TelecommunicationAddressUse. Check all 'cda:telecom' tags 'use'
                attributes to find the incorrect value. Refer to section 8.7 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @value is Mobile but @use is not specified -->
            <report test="
                @value and
                (document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Electronic_Communication_Medium']/code[
                    (@code            = substring-before(current()/@value,':')) or
                    (@alternativeCode = substring-before(current()/@value,':'))
                ]/@alternativeCode = 'M')
                and not (@use)
                ">Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Usage Code" -
                The 'telecom' tag shall have 'value' and 'use' attributes with 'use' attribute
                as 'MC' when 'value' attribute is 'Mobile'. Refer to section 8.7 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @value is Pager but @use is not specified -->
            <report test="
                @value and
                (document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Electronic_Communication_Medium']/code[
                    (@code            = substring-before(current()/@value,':')) or
                    (@alternativeCode = substring-before(current()/@value,':'))
                ]/@alternativeCode = 'P')
                and not(@use)
                ">Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Usage Code" -
                The 'telecom' tag shall have 'value' and 'use' attributes with 'use' attribute
                as 'PG' when 'value' attribute is 'Pager'. Refer to section 8.7 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @value is Mobile, @use exist and not contains space(single use code), and @use is not 'MC'-->
            <report test="
                @value and
                @use and normalize-space(@use) != '' and
                not(contains(@use, ' ')) and
                (document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Electronic_Communication_Medium']/code[
                    (@code            = substring-before(current()/@value,':')) or
                    (@alternativeCode = substring-before(current()/@value,':'))
                ]/@alternativeCode = 'M') and
                (current()/@use != 'MC')
                ">Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Usage Code" -
                The 'telecom' tag shall have 'value' and 'use' attributes with 'use' attribute
                as 'MC' when 'value' attribute is 'Mobile'. Refer to section 8.7 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @value is Pager, @use exist and not contains space(single use code), and @use is not 'PG'-->
            <report test="
                @value and
                @use and normalize-space(@use) != '' and
                not(contains(@use, ' ')) and
                (document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Electronic_Communication_Medium']/code[
                    (@code            = substring-before(current()/@value,':')) or
                    (@alternativeCode = substring-before(current()/@value,':'))
                ]/@alternativeCode = 'P') and
                (current()/@use != 'PG')
                ">Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Usage Code" -
                The 'telecom' tag shall have 'value' and 'use' attributes with 'use' attribute
                as 'PG' when 'value' attribute is 'Pager'. Refer to section 8.7 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @value is Mobile, @use exist and contains one space(two use codes), and both use codes of @use are not 'MC'-->
            <report test="
                @value and
                @use and normalize-space(@use) != '' and
                contains(@use, ' ') and
                not(contains(substring-after(@use, ' '), ' ')) and
                (document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Electronic_Communication_Medium']/code[
                    (@code            = substring-before(current()/@value,':')) or
                    (@alternativeCode = substring-before(current()/@value,':'))
                ]/@alternativeCode = 'M') and
                (substring-before(current()/@use, ' ') != 'MC') and
                (substring-after (current()/@use, ' ') != 'MC')
                ">Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Usage Code" -
                The 'telecom' tag shall have 'value' and 'use' attributes with 'use' attribute
                as 'MC' when 'value' attribute is 'Mobile'. Refer to section 8.7 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

            <!-- @value is Pager, @use exist and contains one space(two use codes), and both use codes of @use are not 'PG'-->
            <report test="
                @value and
                @use and normalize-space(@use) != '' and
                contains(@use, ' ') and
                not(contains(substring-after(@use, ' '), ' ')) and
                (document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'Health_Care_Client_Electronic_Communication_Medium']/code[
                    (@code            = substring-before(current()/@value,':')) or
                    (@alternativeCode = substring-before(current()/@value,':'))
                ]/@alternativeCode = 'P') and
                (substring-before(current()/@use, ' ') != 'PG') and
                (substring-after (current()/@use, ' ') != 'PG')
                ">Error: e-Referral -
                Global Clinical Document check for 'cda:telecom' -
                "Electronic Communication Usage Code" -
                The 'telecom' tag shall have 'value' and 'use' attributes with 'use' attribute
                as 'PG' when 'value' attribute is 'Pager'. Refer to section 8.7 of the
                e-Referral_CDA_Implementation_Guide_v2.2.</report>

        </rule>




        <!-- BEGIN :: observation/text -->
        <!-- BEGIN :: observation/value -->

        <rule context = "cda:observation/cda:text |
                         cda:observation/cda:value">

            <report test="@xsi:type and normalize-space(@xsi:type) = ''"
                >Error: e-Referral -
                Global Clinical Document check for 'observation/text' or 'observation/value' tag -
                The 'text' or 'value' tag 'xsi:type' attribute shall contain a value.
                Check all 'cda:observation/cda:text' or 'cda:observation/cda:value' tags to find
                the 'text' or 'value' with blank 'xsi:type' attribute value.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 3.4.1 and 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</report>

            <report test = "count(cda:reference) > 1"
                >Error: e-Referral -
                Global Clinical Document check for 'observation/value' tag -
                The 'reference' tag shall appear only once.
                Check all 'cda:observation/cda:value' tags to find the duplicated 'reference' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 3.4.1 and 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</report>


            <!-- REQUIREMENT    : ED type with a reference will always be present when an attachment is included,
                                  ==> @mediatype shall appear; otherwise the default of @mediaType (which is text/plain)
                                      is not in the allow list of attachment type -->
            <!-- IMPLEMENTATION : if @xsi:type is 'ED' and cda:reference exists, then @mediaType shall appear -->
            <assert test = "
                not(@xsi:type) or
                normalize-space(@xsi:type) = '' or
                @xsi:type != 'ED' or
                not(cda:reference) or
                @mediaType"
                >Error: e-Referral -
                Global Clinical Document check for 'observation/text' or 'observation/value' tag -
                The 'text' or 'value' tag 'mediaType' attribute is missing for having attachment.
                Check all 'cda:observation/cda:text' or 'cda:observation/cda:value' tags to find
                the 'observation/text' or 'observation/value' tag with 'mediaType' attribute missing.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 3.4.1 and 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <report test = "@mediaType and normalize-space(@mediaType) = ''"
                >Error: e-Referral -
                Global Clinical Document check for 'observation/value' tag -
                The 'mediaType' attribute shall contain a value. Check all
                'cda:observation/cda:value' tags to find the 'mediaType' attribute of missing value.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 3.4.1 and 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</report>


            <!-- REQUIREMENT : For attachment references, if there is a mediaType then the mediaType must of one of the allowed list -->

            <!-- cater for e.g. '<value mediaType="image/jpeg">' in the xml -->
            <report test = "
                cda:reference and
                @mediaType and
                normalize-space(@mediaType) != '' and (
                    not (contains(@mediaType, ';')) and
                    not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'CDA_MIME_Type']/code[@displayName = (current()/@mediaType)])
                )"
                >Error: e-Referral -
                Global Clinical Document check for 'observation/text' or 'observation/value' tag -
                The 'text' or 'value' tag 'mediaType' attribute shall be as per CDA Limitation MIME Type
                defined inside "Common Conformance Profile for Clinical Documents". Check all
                'cda:observation/cda:text' or 'cda:observation/cda:value' tags to find the incorrect
                'mediaType' attribute. Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</report>

            <!-- cater for e.g. '<value mediaType="image/jpeg; xxxxx">' in the xml -->
            <report test = "
                cda:reference and
                @mediaType and
                normalize-space(@mediaType) != '' and (
                    contains(@mediaType, ';') and
                    not(document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'CDA_MIME_Type']/code[@displayName = substring-before(current()/@mediaType, ';')])
                )"
                >Error: e-Referral -
                Global Clinical Document check for 'observation/text' or 'observation/value' tag -
                The 'text' or 'value' tag 'mediaType' attribute shall be as per CDA Limitation MIME Type
                defined inside "Common Conformance Profile for Clinical Documents". Check all
                'cda:observation/cda:text' or 'cda:observation/cda:value' tags to find the incorrect
                'mediaType' attribute.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</report>

        </rule>


        <rule context = "cda:observation/cda:text[@mediaType]/cda:reference |
                         cda:observation/cda:value[@mediaType]/cda:reference |
                         cda:observationMedia/cda:value[@mediaType]/cda:reference">

            <assert test = "@value">Error: e-Referral -
                Global Clinical Document check for 'observation/text', 'observation/value' and
                'observationMedia/value' tag - The 'reference' tag 'value' attribute is missing. Check all
                'cda:observation/cda:text/cda:reference', 'cda:observation/cda:value/cda:reference'
                and 'cda:observationMedia/cda:value/cda:reference' tags to find the missing 'value' attribute.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <assert test = "not(@value) or normalize-space(@value) != ''">Error: e-Referral -
                Global Clinical Document check for 'observation/text', 'observation/value' and
                'observationMedia/value' tag - The 'reference' tag 'value' attribute shall contain a value. Check all
                'cda:observation/cda:text/cda:reference', 'cda:observation/cda:value/cda:reference'
                and 'cda:observationMedia/cda:value/cda:reference' tags to find the empty 'value' attribute.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

        </rule>











        <rule context = "cda:observationMedia">

            <!-- (1) Section is mandatory -->
            <assert test = "ancestor::cda:component[cda:section]"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'narrative' block of 'observationMedia' tag is missing.
                Check all 'cda:observationMedia' tags to find the missing 'narrative ' block.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <!-- (7) There shall be a <observationMedia> element in the <entryRelationship> -->
            <assert test = "
                name(parent::*) = 'entry' or
                name(parent::*) = 'entryRelationship'"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'observationMedia'
                tag shall be a child of 'entry' or 'entryRelationship' tag.
                Check all 'cda:observationMedia' tags to find the incorrect 'observationMedia' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <!-- (8) <observationMedia> shall have a ID attribute value -->
            <assert test = "@ID">Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'observationMedia' tag 'ID' attribute is missing. Check all
                'cda:observationMedia' tags to find the missing 'ID' attribute.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <assert test = "not(@ID) or normalize-space(@ID) != ''">Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'observationMedia' tag 'ID' attribute shall contain a value. Check all
                'cda:observationMedia' tags to find the empty 'ID' attribute.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <!-- (9) Value of 6 shall equal value of 8 -->
            <assert test = "
                not(@ID) or
                @ID = 'LOGO' or
                not(ancestor::cda:component/cda:section/cda:text) or
                not(ancestor::cda:component/cda:section/cda:text//cda:renderMultiMedia) or
                not(ancestor::cda:component/cda:section/cda:text//cda:renderMultiMedia/@referencedObject) or
                ancestor::cda:component/cda:section/cda:text//cda:renderMultiMedia/@referencedObject = @ID">
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'ID' attribute shall match the 'referencedObject' attribute inside 'narrative' block of 'observationMedia'.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <!-- (10) There shall be a <value> element with mediaType attribute -->
            <assert test = "cda:value">Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'value' tag is missing.
                Check all 'cda:observationMedia' tags to find the missing 'value ' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <assert test = "not(cda:value) or cda:value[@mediaType]"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'value' tag 'mediaType' attribute is missing.
                Check all 'cda:observationMedia/cda:value' tags to find the missing 'mediaType ' attribute.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <report test = "count(cda:value) > 1">Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'value' tag shall appear only once.
                Check all 'cda:observationMedia' tags to find the duplicated 'value ' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</report>

        </rule>


        <rule context = "cda:observationMedia/cda:value[@mediaType]">

            <!-- cater for e.g. '<value mediaType="image/jpeg">' in the xml -->
            <assert test = "
                normalize-space(@mediaType) = '' or
                contains(@mediaType, ';') or
                document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'CDA_MIME_Type']/code[@displayName = (current()/@mediaType)]"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia/value' tag - The 'text' tag
                'mediaType' attribute shall be as per CDA Limitation MIME Type defined inside
                "Common Conformance Profile for Clinical Documents".
                NOTE: This restriction shall be applied to PCEHR message only. Ignore this error for non-PCEHR messages.
                Check all 'cda:observationMedia/cda:value' tags to find the incorrect 'mediaType' attribute.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <!-- cater for e.g. '<value mediaType="image/jpeg; xxxxx">' in the xml -->
            <assert test = "
                normalize-space(@mediaType) = '' or
                not(contains(@mediaType, ';')) or
                document('CDAValidate_Vocabs.xml')/systems/system[@codeSystemName = 'CDA_MIME_Type']/code[@displayName = substring-before(current()/@mediaType, ';')]"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia/value' tag - The 'text' tag
                'mediaType' attribute shall be as per CDA Limitation MIME Type defined inside
                "Common Conformance Profile for Clinical Documents".
                NOTE: This restriction shall be applied to PCEHR message only. Ignore this error for non-PCEHR messages.
                Check all 'cda:observationMedia/cda:value' tags to find the incorrect 'mediaType' attribute.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <assert test = "not(@integrityCheck) or normalize-space(@integrityCheck) != ''"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia/value' tag - The
                'integrityCheck' attribute shall contain a value. Check all
                'cda:observationMedia/cda:value' tags to find the empty 'integrityCheck' attribute.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <!-- (11) There shall be a <reference> element with value attribute -->
            <assert test = "cda:reference">Error: e-Referral -
                Global Clinical Document check for 'observationMedia/value' tag - The 'reference'
                tag is missing. Check all
                'cda:observationMedia/cda:value' tags to find the missing 'reference' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <report test = "count(cda:reference) > 1">Error: e-Referral -
                Global Clinical Document check for 'observationMedia/value' tag - The 'reference'
                tag shall appear only once. Check all
                'cda:observationMedia/cda:value' tags to find the duplicated 'reference' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</report>

        </rule>



        <rule context = "cda:component/cda:section[not(descendant::cda:component/cda:section) and
                                                       descendant::cda:observationMedia and
                                                       descendant::cda:observationMedia[@ID!='LOGO']]">

            <!-- (2) Title is mandatory -->
            <assert test = "cda:title"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'title' tag is missing for 'narrative' block of 'observationMedia'.
                Check all 'cda:observationMedia' tags to find the missing 'narrative ' block 'title' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <assert test = "not(cda:title) or normalize-space(cda:title) != ''"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'title' tag for 'narrative' block of 'observationMedia' shall contain a value.
                Check all 'cda:observationMedia' tags to find the empty 'narrative ' block 'title' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <report test = "count(cda:title) > 1"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'title' tag shall appear only once for 'narrative' block of 'observationMedia'.
                Check all 'cda:observationMedia' tags to find the duplicated 'narrative ' block 'title' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</report>

            <!-- (3) Text is mandatory -->
            <assert test = "cda:text"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'text' tag is missing for 'narrative' block of 'observationMedia'.
                Check all 'cda:observationMedia' tags to find the missing 'narrative ' block 'text' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <report test = "count(cda:text) > 1"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'text' tag shall appear only once for 'narrative' block of 'observationMedia'.
                Check all 'cda:observationMedia' tags to find the duplicated 'narrative ' block 'text' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</report>

        </rule>


        <rule context = "cda:component/cda:section[not(descendant::cda:component/cda:section) and
                                                       descendant::cda:observationMedia and
                                                       descendant::cda:observationMedia[@ID!='LOGO']]/
                         cda:text">

            <report test = "@mediaType and normalize-space(@mediaType) = ''"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'text' tag 'mediaType' attribute for 'narrative' block of 'observationMedia' shall contain a value.
                Check all 'cda:observationMedia' tags to find the empty 'mediaType' attribute for 'narrative ' block 'text' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</report>

            <assert test = "not(@mediaType) or
                normalize-space(@mediaType) = '' or
                @mediaType = 'text/x-hl7-text+xml'"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'text' tag 'mediaType' attribute for 'narrative' block of 'observationMedia' shall be 'text/x-hl7-text+xml'.
                Check all 'cda:observationMedia' tags to find the incorrect 'mediaType' attribute for 'narrative ' block 'text' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <!-- (4) Inside the Text element, there shall be a renderMultiMedia -->
            <assert test = "descendant::cda:renderMultiMedia"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'renderMultiMedia' tag is missing inside 'text' tag for 'narrative' block of 'observationMedia'.
                Check all 'cda:observationMedia' tags to find the missing 'renderMultiMedia' tag inside 'text' tag for 'narrative ' block 'text' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <!--
            <report test = "count(descendant::cda:renderMultiMedia) > 1"
                >Error: e-Referral -
                Global Clinical Document check for 'observationMedia' tag - The 'renderMultiMedia' tag shall appear only once inside 'text' tag for 'narrative' block of 'observationMedia'.
                Check all 'cda:observationMedia' tags to find the duplicated 'renderMultiMedia' tag inside 'text' tag for 'narrative ' block 'text' tag.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</report>
            -->

        </rule>


        <!-- any cda:renderMultiMedia descendant nested any level under narrative section cda:text -->
        <rule context = "cda:component/cda:section[not(descendant::cda:component/cda:section) and
                                                       descendant::cda:observationMedia and
                                                       descendant::cda:observationMedia[@ID!='LOGO']]/
                         cda:text//cda:renderMultiMedia">

            <!-- (6) <renderMultiMedia> shall have a referencedObject attribute value -->
            <assert test = "@referencedObject"
                >Error: e-Referral -
                Global Clinical Document check for 'renderMultiMedia' tag - The 'renderMultiMedia' tag 'referencedObject' attribute is missing.
                Check all 'cda:renderMultiMedia' tags to find the missing 'referencedObject' attribute.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

            <assert test = "not(@referencedObject) or normalize-space(@referencedObject) != ''"
                >Error: e-Referral -
                Global Clinical Document check for 'renderMultiMedia' tag - The 'renderMultiMedia' tag 'referencedObject' attribute shall contain a value.
                Check all 'cda:renderMultiMedia' tags to find the empty 'referencedObject' attribute.
                Refer to e-Referral_CDA_Implementation_Guide_v2.2 and section 4.4.1 of the
                Common Conformance Profile for Clinical Documents.</assert>

        </rule>








    </pattern>

